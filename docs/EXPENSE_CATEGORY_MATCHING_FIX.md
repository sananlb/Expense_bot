# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤

## üêõ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –°–∏–º–ø—Ç–æ–º—ã:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å "–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏" –Ω–∞ "–ö–æ–º–º—É–Ω–∞–ª–∫–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏"
- –ò–õ–ò —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Å—Ç–∞–ª–æ—Å—å —Å—Ç–∞—Ä–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ "–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏", –∞ –≤ –∫–æ–¥–µ –Ω–æ–≤–æ–µ "–ö–æ–º–º—É–Ω–∞–ª–∫–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏"
- AI –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–∞–∫ "–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã" (fallback) –≤–º–µ—Å—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- –í –ª–æ–≥–∞—Ö: `Category 'üì± –ö–æ–º–º—É–Ω–∞–ª–∫–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏' not found in user categories, will use AI`

### –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª—å–Ω–æ–π —Ç—Ä–∞—Ç—ã:
```
–¢–µ–∫—Å—Ç: "3100 —Ä –ø–æ—Ç—Ä–∞—Ç–∏–ª –Ω–∞ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å–µ–º—å—è"
–û–∂–∏–¥–∞–ª–æ—Å—å: –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏" (–ø–æ –∫–ª—é—á–µ–≤–æ–º—É —Å–ª–æ–≤—É "—Ç–µ–ª–µ—Ñ–æ–Ω")
–ü–æ–ª—É—á–∏–ª–æ—Å—å: –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã" (fallback)
```

---

## üîç –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏

### –®–∞–≥ –∑–∞ —à–∞–≥–æ–º (—Ñ–∞–π–ª: `bot/utils/expense_parser.py`):

**–®–ê–ì 1-3:** –ü–∞—Ä—Å–∏–Ω–≥ –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Å—É–º–º–∞, –æ–ø–∏—Å–∞–Ω–∏–µ) - ‚úÖ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–®–ê–ì 4: –ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (—Å—Ç—Ä–æ–∫–∏ 516-564)**
```python
if profile:
    user_categories = await get_user_categories()
    for user_cat in user_categories:
        # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
        if user_cat_lower in text_lower or keyword in text_lower:
            category = get_category_display_name(user_cat, lang_code)
```
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –†–ï–ê–õ–¨–ù–´–ï –Ω–∞–∑–≤–∞–Ω–∏—è –∏–∑ –ë–î

**–®–ê–ì 5: –ü–æ–∏—Å–∫ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (—Å—Ç—Ä–æ–∫–∏ 570-579)** ‚ùå –ü–†–û–ë–õ–ï–ú–ê –ó–î–ï–°–¨!
```python
if not category:
    detected_key = detect_expense_category_key(text_lower)  # ‚Üí "utilities_subscriptions"
    if detected_key:
        category_key = detected_key
        category = get_expense_category_display_for_key(category_key, lang_code)
        # ‚Üë –ë–ï–†–ï–¢ –ò–ó –ö–û–î–ê: "üì± –ö–æ–º–º—É–Ω–∞–ª–∫–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏"
        # –ê –£ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: "üì± –ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏"
```

**–®–ê–ì 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å—Ç—Ä–æ–∫–∏ 646-654)**
```python
category_exists = any(
    category.lower() in cat.lower() or cat.lower() in category.lower()
    for cat in user_categories
)
# category = "–ö–æ–º–º—É–Ω–∞–ª–∫–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏" (–∏–∑ –∫–æ–¥–∞)
# user_categories = ["–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏", ...] (–∏–∑ –ë–î)
# –ù–ï –°–û–í–ü–ê–î–ê–ï–¢! ‚Üí category_exists = False
```

**–®–ê–ì 7: –í—ã–∑–æ–≤ AI**
```python
if not category_exists:
    should_use_ai = True
    logger.info(f"Category '{category}' not found in user categories, will use AI")
```

**–®–ê–ì 8: AI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç fallback**
- AI –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ –ë–î
- –ù–æ –Ω–µ –º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Ç–µ–∫—Å—Ç—É "–∞–∫—Å–µ—Å—Å—É–∞—Ä—ã" ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã"

---

## üéØ –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**–§–∞–π–ª:** `bot/utils/expense_parser.py`, —Å—Ç—Ä–æ–∫–∞ 579
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `get_expense_category_display_for_key()`

–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è (`expense_category_definitions.py:299-304`) **–í–°–ï–ì–î–ê** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∂–µ—Å—Ç–∫–æ –ø—Ä–æ–ø–∏—Å–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –∫–æ–¥–∞:

```python
def get_expense_category_display_name(category_key: str, language_code: str = 'ru') -> str:
    data = EXPENSE_CATEGORY_DEFINITIONS.get(category_key)
    return data['name_ru']  # ‚Üê "–ö–æ–º–º—É–Ω–∞–ª–∫–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏" (–ò–ó –ö–û–î–ê!)
```

–≠—Ç–æ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —á—Ç–æ:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
2. –°—Ç–∞—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–º–µ—é—Ç —Å—Ç–∞—Ä—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
3. –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –ë–î –∏ –≤ –∫–æ–¥–µ –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –í–∞—Ä–∏–∞–Ω—Ç 1 (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è:
–ö–æ–≥–¥–∞ –Ω–∞—à–ª–∏ `category_key` –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º - **–ù–ï –±–µ—Ä–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –∫–æ–¥–∞**, –∞ **–∏—â–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** –∫–æ—Ç–æ—Ä–∞—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–æ–º—É –∫–ª—é—á—É.

### –ê–ª–≥–æ—Ä–∏—Ç–º:
1. –û–ø—Ä–µ–¥–µ–ª–∏–ª–∏ `category_key = "utilities_subscriptions"` (–ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º)
2. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
3. –î–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º `normalize_expense_category_key(category.name_ru)`
   - –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º –∫–ª—é—á–æ–º ‚Üí –±–µ—Ä–µ–º –ï–Å –Ω–∞–∑–≤–∞–Ω–∏–µ
4. –ò—Å–ø–æ–ª—å–∑—É–µ–º **—Ä–µ–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –ë–î**: "–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏"
5. –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–∞–π–¥–µ–Ω–∞, AI –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚úÖ

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –±—ã—Å—Ç—Ä–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (–±–µ–∑ AI)
- ‚úÖ –£–º–µ–Ω—å—à–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ AI
- ‚úÖ –ù–µ –ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

---

## üìã –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é

**–§–∞–π–ª:** `bot/utils/expense_parser.py`
**–ú–µ—Å—Ç–æ:** –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 444 (–ø–µ—Ä–µ–¥ `parse_expense_message`)

```python
async def find_user_category_by_key(profile, category_key: str, lang_code: str = 'ru') -> Optional[str]:
    """
    –ù–∞—Ö–æ–¥–∏—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ category_key.

    Args:
        profile: –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        category_key: –ö–ª—é—á –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "utilities_subscriptions")
        lang_code: –ö–æ–¥ —è–∑—ã–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

    Returns:
        –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ None
    """
    from expenses.models import ExpenseCategory
    from asgiref.sync import sync_to_async
    from bot.utils.category_helpers import get_category_display_name

    @sync_to_async
    def get_matching_category():
        categories = ExpenseCategory.objects.filter(profile=profile, is_active=True)

        for cat in categories:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º name_ru
            cat_key_ru = normalize_expense_category_key(cat.name_ru) if cat.name_ru else None
            if cat_key_ru == category_key:
                return get_category_display_name(cat, lang_code)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º name_en
            cat_key_en = normalize_expense_category_key(cat.name_en) if cat.name_en else None
            if cat_key_en == category_key:
                return get_category_display_name(cat, lang_code)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ name (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
            cat_key_name = normalize_expense_category_key(cat.name) if cat.name else None
            if cat_key_name == category_key:
                return get_category_display_name(cat, lang_code)

        return None

    return await get_matching_category()
```

### –≠—Ç–∞–ø 2: –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ parse_expense_message

**–§–∞–π–ª:** `bot/utils/expense_parser.py`
**–°—Ç—Ä–æ–∫–∏:** 570-579

**–ë–´–õ–û:**
```python
if not category:
    lang_code = profile.language_code if profile and hasattr(profile, 'language_code') else 'ru'
    detected_key = detect_expense_category_key(text_lower)
    if detected_key:
        category_key = detected_key
        category = get_expense_category_display_for_key(category_key, lang_code)  # ‚ùå –ò–ó –ö–û–î–ê
```

**–î–û–õ–ñ–ù–û –ë–´–¢–¨:**
```python
if not category:
    lang_code = profile.language_code if profile and hasattr(profile, 'language_code') else 'ru'
    detected_key = detect_expense_category_key(text_lower)
    if detected_key:
        category_key = detected_key

        # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ—Ñ–∏–ª—å - –∏—â–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∫–ª—é—á—É
        if profile:
            category = await find_user_category_by_key(profile, category_key, lang_code)  # ‚úÖ –ò–ó –ë–î

        # Fallback: –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –±–µ—Ä–µ–º –∏–∑ definitions
        if not category:
            category = get_expense_category_display_for_key(category_key, lang_code)
```

### –≠—Ç–∞–ø 3: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ —Å `find_user_category_by_key`:**

```python
if category:
    logger.info(f"Found user category '{category}' by key '{category_key}'")
else:
    logger.info(f"User category not found for key '{category_key}', using default")
```

### –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ —Å—Ç–∞—Ä—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º:**
   - –í –ë–î: "–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏"
   - –í–≤–æ–¥: "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç 500"
   - –û–∂–∏–¥–∞–µ—Ç—Å—è: –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏" ‚úÖ

2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª –∫–∞—Ç–µ–≥–æ—Ä–∏—é:**
   - –í –ë–î: "–ú–æ—è –∫–æ–º–º—É–Ω–∞–ª–∫–∞"
   - –í–≤–æ–¥: "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç 500"
   - –û–∂–∏–¥–∞–µ—Ç—Å—è: –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ú–æ—è –∫–æ–º–º—É–Ω–∞–ª–∫–∞" ‚úÖ

3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–∏–ª —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:**
   - –ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ utilities_subscriptions
   - –í–≤–æ–¥: "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç 500"
   - –û–∂–∏–¥–∞–µ—Ç—Å—è: AI –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –¥—Ä—É–≥—É—é –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚úÖ

4. **–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):**
   - –í –ë–î: "–ö–æ–º–º—É–Ω–∞–ª–∫–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏" (–Ω–æ–≤–æ–µ)
   - –í–≤–æ–¥: "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç 500"
   - –û–∂–∏–¥–∞–µ—Ç—Å—è: –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ö–æ–º–º—É–Ω–∞–ª–∫–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏" ‚úÖ

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –£–ª—É—á—à–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ normalize_expense_category_key

**–§–∞–π–ª:** `bot/utils/expense_category_definitions.py:307-334`

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–µ–π—á–∞—Å —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á–µ—Ä–µ–∑ `aliases` –∏ `keywords`, –Ω–æ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —á–∞—Å—Ç–∏—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:

```python
def normalize_expense_category_key(label: Optional[str]) -> Optional[str]:
    """Map a raw category label to a canonical category key."""
    if not label:
        return None
    cleaned = strip_leading_emoji(label).lower()
    if not cleaned:
        return None

    for key, data in EXPENSE_CATEGORY_DEFINITIONS.items():
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å name_ru/name_en
        potential_matches = {
            strip_leading_emoji(data['name_ru']).lower(),
            strip_leading_emoji(data['name_en']).lower(),
        }
        if cleaned in potential_matches:
            return key

        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º aliases
        for alias in data.get('aliases', []):
            alias_lower = alias.lower()
            if alias_lower and (alias_lower == cleaned or alias_lower in cleaned or cleaned in alias_lower):
                return key

        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º keywords (–ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–ª–æ–≤!)
        for keyword in data.get('keywords', []):
            keyword_lower = keyword.lower()
            # –¢–æ–ª—å–∫–æ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–ª–æ–≤ (< 4 —Å–∏–º–≤–æ–ª–∞)
            if len(keyword_lower) < 4:
                if keyword_lower == cleaned:
                    return key
            else:
                # –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ - –≤—Ö–æ–∂–¥–µ–Ω–∏–µ
                if keyword_lower and (keyword_lower == cleaned or keyword_lower in cleaned or cleaned in keyword_lower):
                    return key

    return None
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç 500"
–ü–∞—Ä—Å–µ—Ä: –ù–∞—à–µ–ª –∫–ª—é—á "utilities_subscriptions"
–ü–∞—Ä—Å–µ—Ä: –í–∑—è–ª –∏–∑ –∫–æ–¥–∞ "–ö–æ–º–º—É–Ω–∞–ª–∫–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏"
–ü–∞—Ä—Å–µ—Ä: –ù–µ –Ω–∞—à–µ–ª —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—É –Ω–µ–≥–æ "–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏")
–ü–∞—Ä—Å–µ—Ä: –í—ã–∑—ã–≤–∞–µ–º AI
AI: "–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã" (fallback)
‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç 500"
–ü–∞—Ä—Å–µ—Ä: –ù–∞—à–µ–ª –∫–ª—é—á "utilities_subscriptions"
–ü–∞—Ä—Å–µ—Ä: –ò—â—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —ç—Ç–∏–º –∫–ª—é—á–æ–º
–ü–∞—Ä—Å–µ—Ä: –ù–∞—à–µ–ª "–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏" (–∏–∑ –ë–î)
–ü–∞—Ä—Å–µ—Ä: –ò—Å–ø–æ–ª—å–∑—É—é —ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (–±–µ–∑ –≤—ã–∑–æ–≤–∞ AI!)
```

---

## ‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –º–µ—Ä—ã –ø—Ä–µ–¥–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏

### –†–∏—Å–∫ 1: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
**–ü—Ä–æ–±–ª–µ–º–∞:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
**–†–µ—à–µ–Ω–∏–µ:**
- –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω `category_key`
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –ø–∞–º—è—Ç—å –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —ç—Ç–∞–ø–∞—Ö
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–∞–ø—Ä–æ—Å–∞

### –†–∏—Å–∫ 2: –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
**–†–µ—à–µ–Ω–∏–µ:**
- Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º

### –†–∏—Å–∫ 3: Edge cases
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–ª 2 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∫–ª—é—á–æ–º
**–†–µ—à–µ–Ω–∏–µ:**
- –§—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω–µ—Ç –ø–µ—Ä–≤—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é
- –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥—É–±–ª–µ–π –ø–æ –∫–ª—é—á—É
- –ï—Å–ª–∏ –µ—Å—Ç—å –¥—É–±–ª–∏ - —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

## üìù –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `find_user_category_by_key()`
- [ ] –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ `parse_expense_message()` (—Å—Ç—Ä–æ–∫–∏ 570-579)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è 4 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
- [ ] –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
- [ ] –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ (3-7 –¥–Ω–µ–π)
- [ ] –ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ AI (—É–º–µ–Ω—å—à–µ–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–≥–æ–≤ –≤ Sentry

---

## üöÄ –î–µ–ø–ª–æ–π –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è:
```bash
# –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥
cd /home/batman/expense_bot && git pull origin master

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
docker-compose restart bot

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose logs --tail=200 bot | grep -E "Found user category|User category not found"
```

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–∑–æ–≤–æ–≤ AI (–¥–æ–ª–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å—Å—è)
2. –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–¥–æ–ª–∂–µ–Ω –≤—ã—Ä–∞—Å—Ç–∏)
3. –û—à–∏–±–∫–∏ –≤ Sentry (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–æ–≤—ã—Ö)
4. –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ (–Ω–µ –¥–æ–ª–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å—Å—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ)

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-17
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π (–≤–ª–∏—è–µ—Ç –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
