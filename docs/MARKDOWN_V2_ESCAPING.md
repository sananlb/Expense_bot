# MarkdownV2 Escaping в Telegram Bot API

## Проблема
При отправке сообщений через Telegram Bot API с `parse_mode='MarkdownV2'` необходимо экранировать специальные символы, иначе возникает ошибка:
```
Bad Request: can't parse entities: Character '(' is reserved and must be escaped with the preceding '\'
```

## Специальные символы в MarkdownV2
Следующие символы должны быть экранированы обратным слешем `\`:
```
_ * [ ] ( ) ~ ` > # + - = | { } . !
```

## Правильное экранирование

### ❌ Неправильно:
```python
text = f"Расходы: 1000 ₽ (25 записей)"
text = f"*Заголовок*"
text = f"Топ-5 категорий"
```

### ✅ Правильно:
```python
# Вариант 1: Экранировать вручную
text = f"Расходы: 1000 ₽ \\(25 записей\\)"
text = f"\\*Заголовок\\*"
text = f"Топ\\-5 категорий"

# Вариант 2: Использовать функцию экранирования
def escape_markdown_v2(text):
    special_chars = ['_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!']
    for char in special_chars:
        text = text.replace(char, f'\\{char}')
    return text

text = escape_markdown_v2("Расходы: 1000 ₽ (25 записей)")
```

## Частые ошибки

### 1. Двойное экранирование
```python
# ❌ Неправильно - двойное экранирование
esc = escape_markdown_v2
text = f"\\({esc('25 записей')}\\)"  # Скобки экранируются дважды!

# ✅ Правильно
text = esc("(25 записей)")  # Функция сама экранирует скобки
```

### 2. Забытые звездочки для bold текста
```python
# ❌ Неправильно
text = f"*Заголовок*"  # Звездочки не экранированы

# ✅ Правильно
text = f"\\*Заголовок\\*"  # Звездочки экранированы
```

### 3. Дефисы и точки
```python
# ❌ Неправильно
text = "Топ-5 категорий за 01.01.2024"

# ✅ Правильно
text = "Топ\\-5 категорий за 01\\.01\\.2024"
# Или
text = escape_markdown_v2("Топ-5 категорий за 01.01.2024")
```

## Решение в проекте ExpenseBot

В проекте используется функция `escape_markdown_v2()` в файле `bot/services/admin_notifier.py`:

```python
def escape_markdown_v2(text: str) -> str:
    """Экранирование специальных символов для MarkdownV2"""
    if not text:
        return ""
    text = str(text)
    special_chars = ['_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!']
    for char in special_chars:
        text = text.replace(char, f'\\{char}')
    return text
```

В `celery_tasks.py` используется сокращение:
```python
def esc(v) -> str:
    return escape_markdown_v2(str(v))
```

## Правила для отчетов

1. **Все динамические значения** должны проходить через `esc()`:
   ```python
   f"Всего: {esc(total)}"
   ```

2. **Статический текст с форматированием** - экранировать вручную:
   ```python
   f"\\*Заголовок\\*"  # Bold текст
   f"\\_Подчеркнутый\\_"  # Underline
   ```

3. **Смешанный текст** - экранировать отдельно:
   ```python
   f"\\*Категория:\\* {esc(category_name)}"
   ```

## Тестирование

Перед отправкой сообщения всегда проверяйте экранирование:

```python
# Тест экранирования
text = "Тест (скобки) и *звездочки* и точки."
escaped = escape_markdown_v2(text)
print(escaped)
# Вывод: Тест \\(скобки\\) и \\*звездочки\\* и точки\\.
```

## История проблем

### 2025-09-10: Ошибка в ежедневных отчетах
**Проблема:** Отчеты не отправлялись из-за неэкранированных символов
**Решение:** 
1. Экранированы все звездочки для bold текста
2. Исправлено двойное экранирование скобок
3. Добавлено экранирование дефисов в "Топ-5"

## Чеклист при добавлении нового текста

- [ ] Все скобки `()` экранированы или обработаны через `esc()`
- [ ] Все звездочки `*` для bold текста экранированы как `\\*`
- [ ] Все точки `.` в датах и числах экранированы
- [ ] Все дефисы `-` экранированы
- [ ] Нет двойного экранирования (не применяем `\\(` если уже используем `esc()`)
- [ ] Протестировано локально перед деплоем