# CLAUDE.md

Этот файл предоставляет руководство для Claude Code (claude.ai/code) при работе с кодом в данном репозитории.

## Команды

### Разработка
```bash
# Запуск бота
python run_bot.py                    # Автономный режим
python manage.py runserver           # Django сервер
docker-compose up                    # Контейнеризованный режим

# Операции с базой данных
python manage.py makemigrations
python manage.py migrate
python manage.py createsuperuser     # Создание администратора

# Тестирование
python manage.py test expenses       # Запуск тестов приложения
python manage.py test bot           # Тестирование функций бота
python manage.py check              # Проверка проекта

# Операции Celery
celery -A expense_bot worker -l info
celery -A expense_bot beat -l info
python start_redis_celery.py        # Запуск Redis и Celery
```

### Управление в продакшене
```bash
./manage.sh start                    # Запуск бота в продакшене
./manage.sh stop                     # Остановка бота
./manage.sh restart                  # Перезапуск бота
./manage.sh status                   # Проверка статуса бота

# ВАЖНО: После изменения кода на сервере необходимо пересобрать Docker контейнер!
cd /path/to/expense_bot/deploy
docker-compose down
docker-compose build --no-cache bot celery-worker celery-beat
docker-compose up -d
```

### КРИТИЧЕСКИ ВАЖНОЕ ПРАВИЛО - СИНХРОНИЗАЦИЯ КОДА С СЕРВЕРОМ

**ВАЖНО: ВСЕ ИЗМЕНЕНИЯ ДЕЛАЕМ ТОЛЬКО ЛОКАЛЬНО!**
1. **НИКОГДА не редактируем файлы напрямую на сервере**
2. **Все изменения делаем локально в /mnt/c/Users/_batman_/Desktop/expense_bot/**
3. **Коммитим изменения в Git**
4. **На сервере делаем ТОЛЬКО git pull из репозитория**

**Процесс обновления сервера:**
```bash
# ЛОКАЛЬНО (в WSL)
cd /mnt/c/Users/_batman_/Desktop/expense_bot/
# Делаем изменения
git add .
git commit -m "описание изменений"
git push origin master

# НА СЕРВЕРЕ (под пользователем batman)
cd /home/batman/expense_bot
# ВАЖНО: Не сохраняем локальные изменения на сервере!
git stash  # Сохраняем временно если есть изменения
git pull origin master
# Или принудительно сбрасываем к версии с GitHub:
git fetch origin
git reset --hard origin/master

docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

**КРИТИЧЕСКИ ВАЖНО:**
- Версия на сервере ВСЕГДА должна соответствовать версии в GitHub
- НЕ коммитим изменения с сервера
- При конфликтах делаем `git reset --hard origin/master`

**ЗАПРЕЩЕНО:**
1. Редактировать файлы на сервере через nano, vim или cat
2. Копировать отдельные файлы через scp
3. Создавать или изменять конфигурационные файлы напрямую на сервере
4. Вносить любые изменения в код на продакшн сервере

## ИНФОРМАЦИЯ О СЕРВЕРЕ

### Продакшн сервер
- **IP адрес:** 80.66.87.178
- **ОС:** Ubuntu 22.04.5 LTS
- **Hostname:** vm977127
- **Пользователи:**
  - root (доступ отключен через SSH)
  - batman (sudo права, SSH по ключу)
- **SSH ключ:** ssh-ed25519 (хранится в C:\Users\_batman_\.ssh\id_ed25519)
- **Путь проекта на сервере:** /home/batman/expense_bot/

### Структура проекта на сервере
Файлы и директории:
- `.env` (настройки окружения)
- `docker-compose.yml`
- `docker-entrypoint.sh` (существует, права 644, владелец root:root)
- `Dockerfile`
- `bot/` (код бота)
- `expenses/` (Django приложение)
- `expense_bot/` (Django проект)
- `venv/` (виртуальное окружение)
- `logs/` (логи)
- `database/` (данные БД)
- `requirements.txt`

### Docker контейнеры на сервере
- **expense_bot_db** (PostgreSQL 15-alpine) - работает
- **expense_bot_redis** (Redis 7-alpine) - работает  
- **expense_bot_app** (основной бот) - перезапускается (ошибка с entrypoint)
- **expense_bot_celery** - перезапускается
- **expense_bot_celery_beat** - перезапускается
- **expense_bot_web** (Django admin) - перезапускается
- **expense_bot_nginx** - перезапускается

### Текущие проблемы
1. **Контейнеры перезапускаются** с ошибкой: "exec /docker-entrypoint.sh: no such file or directory"
2. **docker-entrypoint.sh существует** но не исполняется

### Установленное ПО
- **Docker version:** 27.5.1
- **docker-compose version:** 1.29.2
- **git version:** 2.34.1
5. Обновление ТОЛЬКО через `git pull` для всего проекта целиком

**Правильное обновление сервера:**
```bash
cd /path/to/expense_bot && git pull origin main && cd deploy && docker-compose down && docker-compose build --no-cache bot celery-worker celery-beat && docker-compose up -d
```

**Правильная структура проекта:**
```
/path/to/expense_bot/
├── bot/                    # Telegram Bot (aiogram)
├── expense_bot/            # Django проект
├── expenses/               # Django приложение
├── database/               # Модели БД
├── deploy/                 # Конфигурации для деплоя
│   ├── app-server/         # Docker конфигурация приложения
│   └── db-server/          # Docker конфигурация БД
├── logs/                   # Логи приложения
├── docs/                   # Документация
├── requirements.txt        # Зависимости Python
├── manage.py               # Django управление
└── run_bot.py              # Запуск бота
```

## Архитектура

### Основные компоненты

1. **Bot Entry Point**: `bot/main.py` - Основная логика Telegram бота с обработчиками команд
2. **Routers**: `bot/routers/` - Специализированные роутеры для обработки команд и сообщений
3. **Services**: `bot/services/` - Бизнес-логика для расходов, пользователей и кешбэков
4. **Django Backend**: `expense_bot/` и `expenses/` - REST API и административная панель
5. **Database Models**: `database/models.py` - Модели Django для пользователей, расходов и категорий

### Ключевые паттерны проектирования

1. **Стратегия кеширования**: Redis кеширование для оптимизации производительности
2. **Обработка ошибок**: Комплексная обработка ошибок с уведомлениями администратора
3. **Асинхронная обработка**: Celery для фоновых задач (PDF отчеты, уведомления)
4. **Микросервисная архитектура**: Разделение бота и веб-сервиса

### Схема базы данных

- **users_profile**: Профили пользователей с настройками локализации
- **expenses_category**: Категории расходов (персональные для каждого пользователя)
- **expenses_expense**: Записи о расходах с AI категоризацией
- **expenses_cashback**: Информация о кешбэках банковских карт
- **users_settings**: Настройки уведомлений и предпочтений

### Внешние сервисы

1. **Telegram Bot API**: Основное взаимодействие с пользователями
2. **AI сервисы**: Автоматическая категоризация расходов
3. **Redis**: Кеширование и брокер сообщений Celery
4. **PostgreSQL**: Основная база данных (SQLite для разработки)

### Важные соображения

1. **Rate Limiting**: Реализовано в middleware для предотвращения злоупотреблений
2. **Многоязычность**: Поддержка русского и английского языков
3. **Обработка естественного языка**: Парсинг расходов из произвольного текста
4. **Система кешбэков**: Автоматический расчет потенциальных кешбэков
5. **PDF отчеты**: Генерация красивых отчетов с графиками

## КРИТИЧЕСКИЕ ПРАВИЛА - НЕ НАРУШАТЬ

1. **НИКОГДА не изменяй пользовательский интерфейс без явного разрешения**
2. **НИКОГДА не добавляй новые команды бота, пункты меню или настройки для пользователей**
3. **НИКОГДА не изменяй сообщения бота, ответы или поток взаимодействия**
4. **Только изменения бэкенда**: Можешь изменять внутреннюю логику, оптимизацию и обработку данных
5. **Всегда спрашивай перед**: Добавлением полей, которые пользователи могут видеть или изменять, изменением поведения бота, добавлением новых функций
6. **НИКОГДА не создавай новые файлы без явного разрешения** - всегда спрашивай перед созданием любого нового файла
7. **НИКОГДА НЕ ВВОДИ ИЗМЕНЕНИЯ БЕЗ ОДОБРЕНИЯ** - всегда показывай изменения и жди подтверждения перед их реализацией

В случае сомнений, СПРАШИВАЙ СНАЧАЛА перед реализацией любых изменений, влияющих на то, что видят пользователи или как они взаимодействуют с ботом.

У нас коммерческий проект, развернутый на сервере. Изменяй только то, что относится к проблеме. Изменяем файлы, которые уже есть в проекте, если не видишь нужный файл, не придумывай его, а скажи мне, я добавлю. Сначала планируем и обсуждаем.

## ВАЖНОЕ ПРАВИЛО ДЛЯ ИЗМЕНЕНИЙ

**ВСЕГДА обсуждай структуру изменений ПЕРЕД реализацией:**
1. Предпочитай простые решения сложным архитектурным паттернам
2. Если можно решить задачу добавлением if/else в существующий файл - делай так
3. НЕ создавай новые файлы и классы без явной необходимости
4. НЕ применяй паттерны проектирования (Strategy, Factory и т.д.) без обсуждения
5. Показывай варианты: "Можно сделать просто (if/else) или сложно (новые классы)"

**Пример:**
- ❌ НЕ ДЕЛАЙ: Создавать базовый класс, наследников и селектор для выбора между API
- ✅ ДЕЛАЙ: Добавить if/else в существующий метод для выбора между API

## ВАЖНО: Режим работы с сервером

**У меня НЕТ прямого доступа к серверу!**
- Я предоставляю команды для выполнения
- Пользователь выполняет команды на сервере
- Пользователь предоставляет мне результаты
- Я анализирую результаты и предлагаю следующие шаги

## Инфраструктура продакшена

### Архитектура сервера
ExpenseBot развертывается на сервере с использованием Docker контейнеров для изоляции и управления зависимостями.

### Основные компоненты
**Docker контейнеры**:
- `expense_bot` - Telegram бот
- `expense_web` - Django веб-приложение и API
- `expense_celery_worker` - Celery воркер для фоновых задач
- `expense_celery_beat` - Celery beat для периодических задач
- `expense_redis` - Redis для кеширования и очереди задач
- `expense_postgres` - PostgreSQL база данных

**Важные файлы**:
- `docker-compose.yml` - конфигурация контейнеров
- `.env` - переменные окружения
- `requirements.txt` - зависимости Python

### Диагностика проблем

#### 1. Проверка статуса сервисов
```bash
docker-compose ps
docker-compose logs --tail=50 expense_bot
docker-compose logs --tail=50 expense_celery_worker
```

#### 2. Частые проблемы
- **Бот не отвечает**: проверить Redis и PostgreSQL
- **Ошибки подключения к БД**: проверить DATABASE_URL в .env файле
- **Redis timeout**: проверить что Redis запущен и доступен
- **Celery не обрабатывает задачи**: проверить celery-worker и Redis

#### 3. Проверка подключения к БД
```bash
docker-compose exec expense_web python manage.py dbshell
# Внутри psql: \l для списка баз, \dt для таблиц, \q для выхода
```

#### 4. После изменения кода
```bash
docker-compose down
docker-compose build --no-cache expense_bot expense_web
docker-compose up -d
```

### Критические замечания
- НЕ удаляйте Docker volumes без явной необходимости
- Всегда проверяйте к какому volume подключен контейнер перед изменениями
- При перезапуске PostgreSQL используйте существующий volume с данными
- Регулярно создавайте резервные копии базы данных

## Особенности проекта

### 1. Обработка естественного языка
ExpenseBot умеет парсить расходы из произвольного текста:
- "кофе 200" → категория "Рестораны и кафе", сумма 200₽
- "дизель 4095 азс" → категория "АЗС", сумма 4095₽
- "купил молоко за 85р в магните" → категория "Супермаркеты", сумма 85₽

### 2. AI категоризация
- Автоматическое определение категории через машинное обучение
- Показ уверенности AI (0-100%)
- Возможность корректировки пользователем
- Обучение системы на основе исправлений

### 3. Система кешбэков
- Поддержка множественных банков для одной категории
- Лимиты кешбэков по месяцам
- Автоматический расчет потенциального кешбэка
- Месячные заметки о действующих кешбэках

### 4. Многоязычность
- Полная поддержка русского и английского языков
- Автоматическое определение языка по Telegram
- Локализованные сообщения и интерфейс

### 5. PDF отчеты
- Красивые отчеты с графиками и диаграммами
- Экспорт данных за любой период
- Включение информации о кешбэках
- Высокое качество для печати

## Файловая структура

### Bot (aiogram)
```
bot/
├── main.py                 # Точка входа бота
├── routers/                # Обработчики команд
│   ├── start.py           # /start команда
│   ├── menu.py            # Главное меню
│   ├── expense.py         # Управление расходами
│   ├── category.py        # Управление категориями
│   ├── cashback.py        # Система кешбэков
│   ├── reports.py         # Отчеты и аналитика
│   └── settings.py        # Настройки пользователя
├── services/              # Бизнес-логика
│   ├── expense.py         # Сервис расходов
│   ├── user.py            # Сервис пользователей
│   └── cashback.py        # Сервис кешбэков
├── middlewares/           # Промежуточное ПО
│   ├── database.py        # Подключение к БД
│   └── localization.py    # Локализация
├── utils/                 # Утилиты
│   ├── commands.py        # Парсинг команд
│   └── expense_parser.py  # Парсинг расходов
└── texts.py               # Тексты локализации
```

### Django Backend
```
expense_bot/               # Django проект
├── settings.py           # Настройки Django
├── urls.py               # URL маршруты
├── wsgi.py              # WSGI конфигурация
└── celery.py            # Настройки Celery

expenses/                 # Django приложение
├── models.py            # Модели данных
├── admin.py             # Админ-панель
├── services/            # Бизнес-логика Django
├── migrations/          # Миграции БД
└── views.py             # API представления
```

## Рекомендации по разработке

### 1. Тестирование
- Всегда тестируй изменения локально перед деплоем
- Используй `python manage.py test` для запуска тестов
- Проверяй работу бота с реальными сценариями

### 2. Логирование
- Используй существующую систему логирования
- Логи находятся в папке `logs/`
- Критические ошибки отправляются администратору

### 3. База данных
- Всегда создавай миграции для изменений в моделях
- Используй индексы для оптимизации производительности
- Регулярно создавай резервные копии

### 4. Безопасность
- Валидируй все входящие данные
- Используй Django ORM для защиты от SQL-инъекций
- Ограничивай размеры файлов и запросов

### 5. Производительность
- Используй Redis для кеширования
- Минимизируй количество запросов к БД
- Оптимизируй тяжелые операции через Celery

## История изменений

Этот раздел будет обновляться по мере развития проекта и решения проблем в продакшене.