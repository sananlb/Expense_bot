# Coins (ExpenseBot) — Полное описание возможностей бота

Последнее обновление: 2025‑09‑09

Этот документ описывает все ключевые функции и поведение бота, включая пользовательские возможности, подписки, партнёрскую программу, отчёты, семейный бюджет, уведомления, фоновые задачи и админ‑интерфейсы.

## Обзор и цели

- Умный учёт личных и семейных финансов в Telegram.
- Быстрый ввод расходов/доходов (текст и голос) с авто‑категоризацией.
- Управление категориями, бюджетами и кешбэками.
- Отчёты и PDF, «Топ‑5» быстрых действий.
- Подписки через Telegram Stars, промокоды, партнёрская программа.
- Продвинутые настройки (язык, часовой пояс, валюта, режим просмотра).
- Админ‑панель и мониторинг состояния системы.

## Пользовательские возможности

### 1) Ввод расходов и доходов
- Текстовый ввод: «Кофе 250», «Дизель 4050», «Премия +40000». Парсер в `bot/utils/expense_parser_improved.py` извлекает сумму, очищает текст, корректирует опечатки.
- Голосовой ввод: поддерживается обработка голосовых сообщений (ограничение по длительности по умолчанию до 60 секунд). Транскрибация:
  - Yandex SpeechKit (при наличии токенов),
  - OpenAI Whisper API (через ротацию ключей),
  - Google Speech‑to‑Text (предусмотрен фолбек‑каркас).
- Категоризация: словарная + усовершенствованная, при наличии ключей может дополняться AI‑подсказками (OpenAI) с повышением уверенности.
- Валюта и формат суммы учитываются настройками пользователя.

### 2) Категории (трат и доходов)
- Просмотр, добавление, переименование и удаление пользовательских категорий.
- Иконки категорий и мультиязычное отображение с хелпером `get_category_display_name(...)`.
- Предустановленные базовые категории создаются для новых пользователей.

### 3) Кешбэки по картам
- Добавление правил кешбэка по категориям (банк, категория, процент) и просмотр их в компактном месячном меню.
- Постоянная панель кешбэка, поддержка нескольких активных панелей (не удаляется при обновлениях).
- Быстрые действия «добавить/редактировать/удалить», подсказки и форматированные заметки.

### 4) Бюджеты и лимиты
- Месячные бюджеты по категориям: установка суммы, просмотр статуса выполнения.
- Проверки превышения и проценты использования (80/90/100%) с уведомлениями.
- Меню управления бюджетами: добавить, удалить, сводка по категориям.

### 5) Отчёты и сводки
- Команда `/summary` и кнопки в отчётах: сводка за сегодня, с начала месяца или за произвольный период.
- Подробности по категориям, форматирование сумм и локализация текстов.
- PDF отчёты по месяцам с графиками (генерация и отправка PDF‑файла).

### 6) «Топ‑5» быстрых операций
- Автоматическая выборка 5 самых частых операций (расходы и доходы) по пользователю.
- Кнопки для мгновенного повторения операции; для расходов учитывается актуальный кешбэк.
- Ежедневное авто‑обновление и обновление закреплённого сообщения (при наличии).

### 7) Регулярные (ежемесячные) операции
- Создание и управление регулярными платежами/доходами.
- Ежедневная обработка и автогенерация по расписанию Celery.

### 8) Семейный бюджет (домохозяйство)
- Создание домохозяйства, приглашение по ссылке `/start family_TOKEN`, выход участников.
- Переименование, управление лимитом участников, режим просмотра «личный/семья».
- В отчётах и сводках можно переключать режим просмотра (личный/семейный). 

### 9) Настройки
- Язык интерфейса (ru/en), часовой пояс (отображение UTC±X), валюта.
- Переключение режима просмотра: личный/семейный (если есть домохозяйство).
- Управление кешбэками (вкл/выкл) и обновление списка команд.

## Подписки и оплата (Telegram Stars)

- Тарифы (см. `bot/routers/subscription.py`):
  - Месяц — 150⭐ (30 дней)
  - 6 месяцев — 600⭐ (180 дней)
- Технически используются одноразовые инвойсы Stars (без настоящей «звёздной» подписки авто‑продления в Telegram). Продление — через БД.
- Пробный период для новых пользователей — 7 дней.
- Промокоды: учёт применения и статистика использования.
- Уведомления о продлении/окончании и преимуществах подписки.

Старая реферальная бонусная система (дополнительно к партнёрской) — при первой платной подписке реферала рефереру может начисляться +30 дней (логика сохранена для совместимости).

## Партнёрская программа (Telegram Stars Affiliate)

- Ссылка `/affiliate`: выдаёт персональную ссылку вида `https://t.me/<bot>?start=ref_<CODE>`.
- Обработка переходов при `/start ref_...` — создаётся `AffiliateReferral`, учитываются регистрации (клики в терминах «регистрации по ссылке»; чистые клики без регистрации не считаются).
- Комиссии: 50% от суммы платежа (150⭐ → 75⭐, 600⭐ → 300⭐).
- Холдинг: 21 день. После окончания холда комиссии переводятся в статус `paid`.
- Статус/история: подробные списки комиссий, рефералов, статистика по заработку и ожиданию.
- Уведомление рефереру о начислении сразу после оплаты (статус «на холде»).
- Celery‑таск раз в день переводит комиссии со статусом `hold` в `paid` (учётно, без вызова payout‑API).
- Кастомная админка (см. ниже) для просмотра: сводка, ссылки, рефералы, комиссии.

Ограничения текущей реализации:
- Чистые «клики» без регистрации не логируются (требования нет — считаем только регистрации и платежи).
- Авто‑выплат звёзд через Telegram API нет: после 21 дня меняется статус в БД (выплата по правилам Stars происходит со стороны Telegram).

## Команды и навигация (основные)

- `/start` — онбординг, обработка реферальных и семейных ссылок, создание профиля, пробный период.
- `/settings` — язык, часовой пояс, валюта, кешбэк, режим просмотра.
- `/categories` — управление категориями трат/доходов.
- `/expenses` — быстрый доступ к тратам (за сегодня и т. п.).
- `/summary` — сводка расходов.
- `/report` — отчёт за период (кнопки выбора периода и PDF‑отчёт через меню).
- `/cashback` — панель кешбэка.
- `/budget` — бюджеты и лимиты по категориям.
- `/recurring` — регулярные операции.
- `/subscription` — покупка подписки Stars, промокод, просмотр статуса.
- `/affiliate` — партнёрская программа (линк, статистика, история).
- `/referral` — поддержка старой реферальной механики (для совместимости).

Инлайн‑клавиатуры и кнопки присутствуют в соответствующих меню (навигация «Назад/Закрыть», действия над объектами и т. п.).

## Отчёты и PDF

- Сводки за сегодня/месяц/произвольный период с разрезом по категориям.
- PDF‑отчёты за выбранный месяц: формирование документа с графиками, отправка файлом.

## Уведомления

- Уведомления о подписках (продление, истечение, преимущества) — `bot/tasks/subscription_notifications.py`.
- Уведомления рефереру о начислении комиссии.
- Системные алерты и отчёты админу (см. «Мониторинг» ниже).

## Фоновые задачи (Celery Beat)

Расписание см. `expense_bot/settings.py` (CELERY_BEAT_SCHEDULE):
- `send_monthly_reports` — месячные отчёты пользователям (в определённый момент времени).
- `process_recurring_payments` — генерация регулярных платежей.
- `check_budget_limits` — проверка лимитов, уведомления о 80/90/100%.
- `cleanup_old_expenses` — периодическая очистка/обслуживание.
- `send_daily_admin_report` — ежедневный отчёт админу.
- `process_held_affiliate_commissions` — перевод комиссий из `hold` в `paid` после 21 дня.
- `system_health_check` — мониторинг работоспособности компонентов (БД, Redis, Telegram, внешние API, Celery, системные метрики).
- `collect_daily_analytics` — сбор агрегатов.
- `update_top5_keyboards` — ежедневное обновление панели «Топ‑5».

## Админ‑интерфейсы

### Django Admin (`/admin`)
- Полный доступ к моделям (пользователи, подписки, категории, операции и т. д.).
- Отдельные админ‑экраны для партнёрской программы (просмотр): Program/Link/Referral/Commission.

### Кастомная админ‑панель (`/panel`)
- Дашборд: метрики активных пользователей, расходов, доходов, подписок, последние события.
- Пользователи: список, детали, продление подписки, отправка сообщений.
- Рассылки: создание, запуск/отмена, мониторинг статуса и ошибок.
- Партнёрская программа:
  - `/panel/affiliate` — сводка (ставка, активность, суммы по статусам, последние комиссии).
  - `/panel/affiliate/links` — список ссылок (поиск, фильтр активности).
  - `/panel/affiliate/referrals` — список рефералов (даты, суммы).
  - `/panel/affiliate/commissions` — список комиссий (поиск, фильтр по статусу, агрегаты).

Доступ в кастомную панель — только для авторизованных пользователей со staff/superuser.

## Мониторинг и стабильность

- System Health Check (`expense_bot/celery_tasks.py#system_health_check`):
  - Проверка базы данных, Redis, Telegram Bot API, OpenAI/Google AI (если ключи заданы), Celery worker/beat, диска/памяти/CPU.
  - Сохранение результатов и отправка алертов админу при деградации/проблемах.
- Rate limiting и защита: middleware ограничивают частоту и проверяют контент на безопасность.
- Хранилище состояний FSM: Redis (если доступен в окружении) или MemoryStorage.

## Интеграции

- Telegram Stars: инвойсы (XTR), обработка `PreCheckout` и `SuccessfulPayment`, маппинг на `Subscription` и партнёрские комиссии.
- Партнёрка Stars: генерация ссылок, idempotency по платежам, холд‑логика, агрегации.
- Голосовые технологии: Yandex SpeechKit / OpenAI Whisper / Google STT (фолбек), хранение файлов во временной папке, уборка.
- AI‑парсинг (опционально): улучшение распознавания категории/описания через OpenAI при наличии ключей и повышении уверенности.

## Ограничения и примечания

- Подписки — не «настоящие» звёздные подписки Telegram с автопродлением; используются одноразовые платежи с последующим продлением в БД.
- В партнёрке учитываем регистрации и платежи; «чистые клики» без регистрации не учитываются.
- Голосовые сообщения ограничены по длительности (настройка по умолчанию 60 сек, можно менять через `MAX_VOICE_DURATION_SECONDS`).
- Некоторые функции AI/распознавания включаются при наличии API‑ключей и могут быть отключены в проде.

## Основные модели (вкратце)

- `Profile`, `UserSettings` — профиль пользователя и настройки (язык, TZ, валюта, режим просмотра, кешбэк).
- `Expense`, `Income`, `ExpenseCategory`, `IncomeCategory` — финансовые операции и категории.
- `Budget` — бюджет по категории (месячный) и статистика выполнения.
- `Cashback` — правила кешбэка (банк/категория/процент) и расчёты в отчётах.
- `RecurringPayment` — регулярные операции.
- `Subscription` — подписки (trial, stars, referral/admin) и сроки действия.
- Партнёрка:
  - `AffiliateProgram` — ставка (в промилле), сроки, активность.
  - `AffiliateLink` — код, ссылка `t.me/bot?start=ref_CODE`, клики(рег.), конверсии, заработано.
  - `AffiliateReferral` — связь реферер ↔ реферал, счетчики платежей/сумм.
  - `AffiliateCommission` — комиссии (сумма платежа, комиссия, ставка, статусы, холд/выплата, telegram ids).

## Ключевые команды для пользователя

- `/start`, `/settings`, `/categories`, `/expenses`, `/summary`, `/report`, `/cashback`, `/budget`, `/recurring`, `/subscription`, `/affiliate`, `/referral`.

Если нужна версия этого документа на английском — могу подготовить `docs/BOT_FEATURES_EN.md`.

