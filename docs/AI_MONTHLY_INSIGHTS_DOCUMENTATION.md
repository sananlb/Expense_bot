# ะะพะบัะผะตะฝัะฐัะธั AI ะผะตัััะฝัั ะธะฝัะฐะนัะพะฒ ะดะปั ExpenseBot

**ะะฐัะฐ ัะพะทะดะฐะฝะธั:** 2025-10-09
**ะะฒัะพั:** Claude Code
**ะกัะฐััั:** โ **ะะะะะะะะะะะ ะ ะะะะะขะะะข**

---

## ๐ ะะณะปะฐะฒะปะตะฝะธะต

1. [ะะฑะทะพั ััะฝะบัะธะพะฝะฐะปัะฝะพััะธ](#ะพะฑะทะพั-ััะฝะบัะธะพะฝะฐะปัะฝะพััะธ)
2. [ะััะธัะตะบัััะฐ ัะตัะตะฝะธั](#ะฐััะธัะตะบัััะฐ-ัะตัะตะฝะธั)
3. [ะะตะฐะปะธะทะพะฒะฐะฝะฝัะต ะบะพะผะฟะพะฝะตะฝัั](#ัะตะฐะปะธะทะพะฒะฐะฝะฝัะต-ะบะพะผะฟะพะฝะตะฝัั)
4. [ะัะพะฑะตะฝะฝะพััะธ ัะตะฐะปะธะทะฐัะธะธ](#ะพัะพะฑะตะฝะฝะพััะธ-ัะตะฐะปะธะทะฐัะธะธ)
5. [ะกะธััะตะผะฐ Fallback ะธ ะพะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ](#ัะธััะตะผะฐ-fallback-ะธ-ะพะฑัะฐะฑะพัะบะฐ-ะพัะธะฑะพะบ)
6. [ะฃะฒะตะดะพะผะปะตะฝะธั ะฐะดะผะธะฝะธัััะฐัะพัั](#ัะฒะตะดะพะผะปะตะฝะธั-ะฐะดะผะธะฝะธัััะฐัะพัั)
7. [ะัะพัะตัั ะดะตะฟะปะพั](#ะฟัะพัะตัั-ะดะตะฟะปะพั)
8. [ะขะตััะธัะพะฒะฐะฝะธะต](#ัะตััะธัะพะฒะฐะฝะธะต)
9. [ะะทะฒะตััะฝัะต ะพะณัะฐะฝะธัะตะฝะธั](#ะธะทะฒะตััะฝัะต-ะพะณัะฐะฝะธัะตะฝะธั)
10. [ะัะดััะธะต ัะปัััะตะฝะธั](#ะฑัะดััะธะต-ัะปัััะตะฝะธั)

---

## ะะฑะทะพั ััะฝะบัะธะพะฝะฐะปัะฝะพััะธ

### ะงัะพ ัะตะฐะปะธะทะพะฒะฐะฝะพ:

AI-powered ะฐะฝะฐะปะธะท ะผะตัััะฝัั ัะธะฝะฐะฝัะพะฒ ะฟะพะปัะทะพะฒะฐัะตะปั, ะบะพัะพััะน **ะฐะฒัะพะผะฐัะธัะตัะบะธ ะดะพะฑะฐะฒะปัะตััั ะฒ caption ะบ PDF ะพััะตัั**.

### ะัะธะผะตั ะฒัะฒะพะดะฐ ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั:

```
๐ ะะถะตะผะตัััะฝัะน ะพััะตั ะทะฐ ะะบััะฑัั 2025

๐ค AI ะฐะฝะฐะปะธะท ะทะฐ ะะบััะฑัั 2025

๐ฐ ะะฐััะพะดั: 30 620 โฝ
๐ ะะพะปะธัะตััะฒะพ ััะฐั: 13

๐ ะขะพะฟ ะบะฐัะตะณะพัะธะน:
1. ะัะพัะธะต ัะฐััะพะดั: 18 400โฝ (60%)
2. ะะธะปัะต: 4 400โฝ (14%)
3. ะะดะตะถะดะฐ ะธ ะพะฑัะฒั: 3 400โฝ (11%)

๐ ะะฐ ะพะบััะฑัั ะฒั ะฟะพััะฐัะธะปะธ 30 620 ััะฑะปะตะน, ััะพ ะฝะฐ 14.7% ะผะตะฝััะต,
ัะตะผ ะฒ ัะตะฝััะฑัะต. ะขัะฐัั ะทะฝะฐัะธัะตะปัะฝะพ ัะพะบัะฐัะธะปะธัั!

๐ ะะปััะตะฒัะต ะผะพะผะตะฝัั:
โข ะัะฝะพะฒะฝะฐั ะบะฐัะตะณะพัะธั: ะัะพัะธะต ัะฐััะพะดั (18 400โฝ, 60%)
โข ะะฐััะพะดั ัะฝะธะทะธะปะธัั ะฝะฐ 15% ะฟะพ ััะฐะฒะฝะตะฝะธั ั ะฟัะพัะปัะผ ะผะตัััะตะผ
โข ะะพะปะธัะตััะฒะพ ััะฐั: 13 (ะฑัะปะพ 53 ะฒ ัะตะฝััะฑัะต)

[PDF ัะฐะนะป ะฟัะธะบัะตะฟะปะตะฝ]
```

### โ ะะปััะตะฒัะต ะพัะพะฑะตะฝะฝะพััะธ:

- **ะะฝัะตะณัะฐัะธั ะฒ ัััะตััะฒัััะธะน ะฟัะพัะตัั** - ะะตะท UI ะธะทะผะตะฝะตะฝะธะน, ะธะฝัะฐะนัั ะดะพะฑะฐะฒะปััััั ะบ PDF
- **ะะดะฐะฟัะธะฒะฝัะน ะบะพะฝัะตะฝั** - ะกะบััะฒะฐะตั ัะฟะพะผะธะฝะฐะฝะธั ะดะพัะพะดะพะฒ/ะฑะฐะปะฐะฝัะฐ ะตัะปะธ ะธั ะฝะตั
- **ะกัะฐะฒะฝะตะฝะธะต ั ะฟัะตะดัะดััะธะผ ะผะตัััะตะผ** - ะะฝะฐะปะธะท ะดะธะฝะฐะผะธะบะธ ัะฐััะพะดะพะฒ
- **ะัะพะฒะตัะบะฐ ะฟะพะดะฟะธัะบะธ** - ะัะฟัะฐะฒะบะฐ ัะพะปัะบะพ ะฟะพะปัะทะพะฒะฐัะตะปัะผ ั ะฐะบัะธะฒะฝะพะน ะฟะพะดะฟะธัะบะพะน
- **Graceful degradation** - PDF ะพัะฟัะฐะฒะปัะตััั ะดะฐะถะต ะตัะปะธ AI ะฝะตะดะพัััะฟะตะฝ
- **Multi-level fallback** - Google Gemini โ OpenAI โ ะฑะตะท AI ะฐะฝะฐะปะธะทะฐ
- **ะฃะฒะตะดะพะผะปะตะฝะธั ะฐะดะผะธะฝั** - ะัะธ ัะฑะพัั ะธ ะธัะฟะพะปัะทะพะฒะฐะฝะธะธ fallback
- **ะะฟัะธะผะธะทะฐัะธั ะดะปะธะฝั** - ะฃะบะปะฐะดัะฒะฐะตััั ะฒ ะปะธะผะธั Telegram (1024 ัะธะผะฒะพะปะฐ)

---

## ะััะธัะตะบัััะฐ ัะตัะตะฝะธั

### ะะพะผะฟะพะฝะตะฝัั ัะธััะตะผั:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         Celery Task: send_monthly_reports                   โ
โ         (1-ะณะพ ัะธัะปะฐ ะบะฐะถะดะพะณะพ ะผะตัััะฐ ะฒ 10:00 MSK)             โ
โ         expense_bot/celery_tasks.py:20-87                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ะคะธะปัััะฐัะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ั ะฐะบัะธะฒะฝะพะน ะฟะพะดะฟะธัะบะพะน             โ
โ   + ััะฐัั ะฒ ะฟัะพัะปะพะผ ะผะตัััะต                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          NotificationService.send_monthly_report            โ
โ          bot/services/notifications.py:22-108               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                โโโโโโโโโโโโโดโโโโโโโโโโโโ
                โผ                       โผ
    โโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโ
    โ MonthlyInsights    โ   โ  PDFReportService    โ
    โ Service            โ   โ  (existing)          โ
    โ (NEW)              โ   โ                      โ
    โโโโโโโโฌโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโ
           โ
           โโโโโโโโโโโโโโโโโโโโโโโ
           โผ                     โผ
โโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโ
โ  Data Collector  โ   โ   AI Generation     โ
โ  (ัะพะฑะธัะฐะตั ะทะฐ    โ   โ   ั Fallback        โ
โ   2 ะผะตัััะฐ)      โ   โ                     โ
โโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโฌโโโโโโโโโโโ
                                  โ
              โโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโ
              โผ                                 โผ
   โโโโโโโโโโโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโโโโโโโโ
   โ  Google Gemini API   โ Fail   โ   OpenAI API        โ
   โ  (Priority 1)        โ โโโโโโ โ   (Priority 2)      โ
   โโโโโโโโโโโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโโโโโโโโ
              โ                                 โ
              โโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
                              โ (ะพะฑะฐ ะฝะตะดะพัััะฟะฝั)
                              โผ
                  โโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ  ะะตะท AI ะฐะฝะฐะปะธะทะฐ        โ
                  โ  (ัะพะปัะบะพ PDF)          โ
                  โโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ะะตะฐะปะธะทะพะฒะฐะฝะฝัะต ะบะพะผะฟะพะฝะตะฝัั

### 1. **MonthlyInsight Model**

**ะคะฐะนะป:** `expenses/models.py:2734`

**ะะฐะทะฝะฐัะตะฝะธะต:** ะฅัะฐะฝะตะฝะธะต ัะณะตะฝะตัะธัะพะฒะฐะฝะฝัั AI ะธะฝัะฐะนัะพะฒ ะดะปั ะบะตัะธัะพะฒะฐะฝะธั

**ะะพะปั:**
```python
class MonthlyInsight(models.Model):
    profile = ForeignKey(Profile)
    year = IntegerField()
    month = IntegerField()
    total_expenses = DecimalField()
    total_incomes = DecimalField()
    expenses_count = IntegerField()
    balance = DecimalField()
    top_categories = JSONField()  # ะขะพะฟ-10 ะบะฐัะตะณะพัะธะน
    ai_summary = TextField()  # ะัะฐัะบะพะต ัะตะทัะผะต ะพั AI
    ai_analysis = TextField()  # ะะปััะตะฒัะต ะผะพะผะตะฝัั
    ai_recommendations = TextField()  # (ะฝะต ะธัะฟะพะปัะทัะตััั)
    ai_model_used = CharField()  # gemini-2.0-flash-exp / gpt-4o
    ai_provider = CharField()  # google / openai

    class Meta:
        unique_together = ['profile', 'year', 'month']
```

**ะะธะณัะฐัะธั:** `expenses/migrations/0048_monthlyinsight.py`

---

### 2. **MonthlyInsightsService**

**ะคะฐะนะป:** `bot/services/monthly_insights.py` (640 ัััะพะบ)

**ะะฐะทะฝะฐัะตะฝะธะต:** ะะตะฝะตัะฐัะธั AI ะธะฝัะฐะนัะพะฒ ั ะบะตัะธัะพะฒะฐะฝะธะตะผ ะธ fallback

**ะัะฝะพะฒะฝัะต ะผะตัะพะดั:**

#### `generate_insight(profile, year, month, provider='google')`
- ะัะพะฒะตััะตั ัััะตััะฒัััะธะน ะธะฝัะฐะนั ะฒ ะะ
- ะกะพะฑะธัะฐะตั ะดะฐะฝะฝัะต ัะตะบััะตะณะพ ะธ ะฟัะตะดัะดััะตะณะพ ะผะตัััะฐ
- ะัะพะฒะตััะตั ะผะธะฝะธะผัะผ ะดะฐะฝะฝัั (3+ ััะฐัั)
- ะะตะฝะตัะธััะตั AI ะฐะฝะฐะปะธะท ั fallback
- ะกะพััะฐะฝัะตั ะฒ ะะ ะดะปั ะบะตัะธัะพะฒะฐะฝะธั

#### `get_insight(profile, year, month)`
- ะะพะปััะฐะตั ัััะตััะฒัััะธะน ะธะฝัะฐะนั ะธะท ะะ

#### `_collect_month_data(profile, year, month)`
- ะกะพะฑะธัะฐะตั ัะฐััะพะดั ะธ ะดะพัะพะดั ะทะฐ ะผะตััั
- ะััะฟะฟะธััะตั ะฟะพ ะบะฐัะตะณะพัะธัะผ
- ะะพะดะณะพัะฐะฒะปะธะฒะฐะตั ัะพะฟ-10 ะบะฐัะตะณะพัะธะน

#### `_build_analysis_prompt(profile, month_data, prev_month_data, year, month)`
- **ะะดะฐะฟัะธะฒะฝัะน ะฟัะพะผะฟั** - ัะฑะธัะฐะตั ัะฟะพะผะธะฝะฐะฝะธั ะดะพัะพะดะพะฒ/ะฑะฐะปะฐะฝัะฐ ะตัะปะธ ะธั ะฝะตั
- ะะบะปััะฐะตั ััะฐะฒะฝะตะฝะธะต ั ะฟัะตะดัะดััะธะผ ะผะตัััะตะผ (ะตัะปะธ ะตััั ะดะฐะฝะฝัะต)
- ะะฝััััะบัะธััะตั AI ัะพะบััะธัะพะฒะฐัััั ัะพะปัะบะพ ะฝะฐ ัะฐััะพะดะฐั (ะตัะปะธ ะฝะตั ะดะพัะพะดะพะฒ)

#### `_generate_ai_insights(profile, month_data, prev_month_data, year, month, provider)`
- ะัะทะพะฒ Google AI ะธะปะธ OpenAI
- ะะฐััะธะฝะณ JSON ะพัะฒะตัะฐ
- Fallback ะฟะฐััะธะฝะณ ะตัะปะธ JSON ะฝะตะฒะฐะปะธะดะตะฝ

---

### 3. **ะะฝัะตะณัะฐัะธั ะฒ NotificationService**

**ะคะฐะนะป:** `bot/services/notifications.py:22-108`

**ะะทะผะตะฝะตะฝะธั:**

```python
async def send_monthly_report(self, user_id, profile, year, month):
    # 1. ะะตะฝะตัะธััะตะผ AI ะธะฝัะฐะนั
    insight = await insights_service.get_insight(profile, year, month)
    if not insight:
        insight = await insights_service.generate_insight(
            profile=profile,
            year=year,
            month=month,
            provider='google'
        )

    # 2. ะะตะฝะตัะธััะตะผ PDF
    pdf_bytes = await pdf_service.generate_monthly_report(...)

    # 3. ะคะพัะผะธััะตะผ caption
    caption = f"๐ ะะถะตะผะตัััะฝัะน ะพััะตั ะทะฐ {month_name} {year}"

    if insight:
        insight_text = self._format_insight_text(insight, month, year)
        full_caption = f"{caption}\n\n{insight_text}"

        # ะัะพะฒะตัะบะฐ ะปะธะผะธัะฐ 1024 ัะธะผะฒะพะปะฐ
        if len(full_caption) <= 1024:
            caption = full_caption
        else:
            # ะะฑัะตะทะบะฐ ั ะผะฝะพะณะพัะพัะธะตะผ
            truncated = insight_text[:max_length] + "..."
            caption = f"{caption}\n\n{truncated}"

    # 4. ะัะฟัะฐะฒะปัะตะผ PDF ั caption
    await self.bot.send_document(
        chat_id=user_id,
        document=pdf_file,
        caption=caption,
        parse_mode='HTML'
    )
```

**ะะตัะพะด ัะพัะผะฐัะธัะพะฒะฐะฝะธั:**

```python
def _format_insight_text(self, insight, month, year):
    text = f"๐ค <b>AI ะฐะฝะฐะปะธะท ะทะฐ {period}</b>\n\n"

    # ะคะธะฝะฐะฝัะพะฒะฐั ัะฒะพะดะบะฐ (ะบะพะผะฟะฐะบัะฝะฐั)
    text += f"๐ฐ ะะฐััะพะดั: {insight.total_expenses:,.0f} โฝ"

    # ะะฐะปะฐะฝั ัะพะปัะบะพ ะตัะปะธ ะตััั ะดะพัะพะดั
    if insight.total_incomes > 0:
        balance_emoji = "๐" if balance >= 0 else "๐"
        text += f" | ะะฐะปะฐะฝั: {balance_emoji} {balance:+,.0f} โฝ"

    text += f"\n๐ ะะพะปะธัะตััะฒะพ ััะฐั: {insight.expenses_count}\n\n"

    # ะขะพะฟ 3 ะบะฐัะตะณะพัะธะธ
    text += "๐ <b>ะขะพะฟ ะบะฐัะตะณะพัะธะน:</b>\n"
    for i, cat in enumerate(insight.top_categories[:3], 1):
        text += f"{i}. {cat['category']}: {cat['amount']:,.0f}โฝ ({cat['percentage']:.0f}%)\n"

    # AI ัะตะทัะผะต ะธ ะฐะฝะฐะปะธะท
    text += f"\n๐ {insight.ai_summary}\n\n"

    if insight.ai_analysis:
        key_points = [line for line in analysis_lines if line.startswith('โข')][:3]
        if key_points:
            text += "๐ <b>ะะปััะตะฒัะต ะผะพะผะตะฝัั:</b>\n"
            text += '\n'.join(key_points)

    return text
```

---

### 4. **ะัะพะฒะตัะบะฐ ะฟะพะดะฟะธัะบะธ ะฒ Celery**

**ะคะฐะนะป:** `expense_bot/celery_tasks.py:58-72`

```python
@shared_task
def send_monthly_reports():
    # ะคะธะปััััะตะผ ะฟะพะปัะทะพะฒะฐัะตะปะตะน ั:
    # 1. ะะฐััะพะดะฐะผะธ ะฒ ะฟัะพัะปะพะผ ะผะตัััะต
    # 2. ะะบัะธะฒะฝะพะน ะฟะพะดะฟะธัะบะพะน

    profiles = Profile.objects.filter(
        id__in=profiles_with_expenses
    ).filter(
        Q(subscriptions__is_active=True, subscriptions__end_date__gt=timezone.now()) |
        Q(subscriptions__is_trial=True, subscriptions__is_active=True)
    ).distinct()

    # ะัะฟัะฐะฒะปัะตะผ ัะพะปัะบะพ ะฟะพะปัะทะพะฒะฐัะตะปัะผ ั ะฟะพะดะฟะธัะบะพะน
    for profile in profiles:
        await service.send_monthly_report(profile.telegram_id, profile)
```

---

## ะัะพะฑะตะฝะฝะพััะธ ัะตะฐะปะธะทะฐัะธะธ

### 1. **ะะดะฐะฟัะธะฒะฝัะน ะบะพะฝัะตะฝั (ัะพะปัะบะพ ัะฐััะพะดั vs ัะฐััะพะดั+ะดะพัะพะดั)**

**ะัะพะฑะปะตะผะฐ:** ะะฝะพะณะธะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ะทะฐะฟะธััะฒะฐัั ัะพะปัะบะพ ัะฐััะพะดั, ะฝะต ะฒะฒะพะดั ะดะพัะพะดั

**ะะตัะตะฝะธะต:**

```python
# ะ _build_analysis_prompt():
has_income = month_data['total_incomes'] > 0

if has_income:
    finance_section = f"""
    - ะัะตะณะพ ะฟะพััะฐัะตะฝะพ: {expenses} โฝ
    - ะัะตะณะพ ะดะพัะพะดะพะฒ: {incomes} โฝ
    - ะะฐะปะฐะฝั: {balance} โฝ
    """
else:
    finance_section = f"""
    - ะัะตะณะพ ะฟะพััะฐัะตะฝะพ: {expenses} โฝ
    """

# ะ ััะฐะฒะฝะตะฝะธะธ ั ะฟัะตะดัะดััะธะผ ะผะตัััะตะผ:
if prev_month_data:
    if has_income:
        comparison = "... ะดะพัะพะดั ะฒ ะฟัะพัะปะพะผ ะผะตัััะต: ..."
    else:
        comparison = "... (ะฑะตะท ัะฟะพะผะธะฝะฐะฝะธั ะดะพัะพะดะพะฒ)"

# ะ ะธะฝััััะบัะธะธ AI:
if not has_income:
    instructions += "ะะ ัะฟะพะผะธะฝะฐะน ะดะพัะพะดั ะธ ะฑะฐะปะฐะฝั, ัะพะบััะธััะนัั ัะพะปัะบะพ ะฝะฐ ัะฐััะพะดะฐั"
```

**ะะตะทัะปััะฐั:** AI ะฝะต ัะฟะพะผะธะฝะฐะตั ะดะพัะพะดั/ะฑะฐะปะฐะฝั ะบะพะณะดะฐ ะธั ะฝะตั

---

### 2. **ะกัะฐะฒะฝะตะฝะธะต ะผะตััั-ะบ-ะผะตัััั**

**ะะพะณะธะบะฐ:**

```python
# ะััะธัะปัะตะผ ะฟัะตะดัะดััะธะน ะผะตััั
prev_month = month - 1 if month > 1 else 12
prev_year = year if month > 1 else year - 1

# ะกะพะฑะธัะฐะตะผ ะดะฐะฝะฝัะต
prev_month_data = await _collect_month_data(profile, prev_year, prev_month)

# ะัะพะฒะตััะตะผ ะดะพััะฐัะพัะฝะพััั ะดะฐะฝะฝัั
if prev_month_data['total_expenses'] == 0 or len(prev_month_data['expenses']) < 3:
    prev_month_data = None  # ะะต ะธัะฟะพะปัะทัะตะผ ะดะปั ััะฐะฒะฝะตะฝะธั
```

**ะัะธะผะตั ะฒ ะฟัะพะผะฟัะต:**

```
ะกะะะะะะะะ ะก ะะะะะซะะฃะฉะะ ะะะกะฏะฆะะ (ัะตะฝััะฑัั):
- ะะฐััะพะดั ะฒ ะฟัะพัะปะพะผ ะผะตัััะต: 35 916 โฝ
- ะะทะผะตะฝะตะฝะธะต ัะฐััะพะดะพะฒ: -5 296 โฝ (-14.7%)
- ะะพะปะธัะตััะฒะพ ััะฐั ะฒ ะฟัะพัะปะพะผ ะผะตัััะต: 53
```

---

### 3. **ะะฟัะธะผะธะทะฐัะธั ะฟะพะด ะปะธะผะธั 1024 ัะธะผะฒะพะปะฐ**

**ะกััะฐัะตะณะธะธ ัะพะบัะฐัะตะฝะธั:**

1. **ะะพะผะฟะฐะบัะฝะพะต ัะพัะผะฐัะธัะพะฒะฐะฝะธะต:**
   - ะคะธะฝะฐะฝัะพะฒะฐั ัะฒะพะดะบะฐ ะฒ ะพะดะฝั ัััะพะบั
   - ะขะพะฟ-3 ะฒะผะตััะพ ัะพะฟ-5 ะบะฐัะตะณะพัะธะน
   - ะฃะฑัะฐะปะธ ัะตะบัะธั "ะะตะบะพะผะตะฝะดะฐัะธะธ"

2. **ะะธะฝะฐะผะธัะตัะบะฐั ะพะฑัะตะทะบะฐ:**
```python
if len(full_caption) > 1024:
    max_insight_length = 1024 - len(base_caption) - 20
    if max_insight_length > 100:
        truncated_insight = insight_text[:max_insight_length] + "..."
        caption = f"{base_caption}\n\n{truncated_insight}"
```

**ะะตะทัะปััะฐั:** ะกัะตะดะฝัั ะดะปะธะฝะฐ ~850 ัะธะผะฒะพะปะพะฒ (ะทะฐะฟะฐั 174 ัะธะผะฒะพะปะฐ)

---

### 4. **ะะตัะธัะพะฒะฐะฝะธะต ะธะฝัะฐะนัะพะฒ**

**ะะพะณะธะบะฐ:**

```python
# ะัะพะฒะตััะตะผ ัััะตััะฒัััะธะน ะธะฝัะฐะนั
existing_insight = MonthlyInsight.objects.filter(
    profile=profile, year=year, month=month
).first()

if existing_insight and not force_regenerate:
    return existing_insight  # ะะพะทะฒัะฐัะฐะตะผ ะธะท ะบะตัะฐ

# ะะตะฝะตัะธััะตะผ ะฝะพะฒัะน ัะพะปัะบะพ ะตัะปะธ ะฝะตั ะฒ ะะ
```

**ะัะตะธะผััะตััะฒะฐ:**
- ะญะบะพะฝะพะผะธั API ะฒัะทะพะฒะพะฒ
- ะะณะฝะพะฒะตะฝะฝัะน ะพัะฒะตั ะฟัะธ ะฟะพะฒัะพัะฝะพะผ ะทะฐะฟัะพัะต
- ะะพะทะผะพะถะฝะพััั ัะตะณะตะฝะตัะฐัะธะธ (force_regenerate=True)

---

## ะกะธััะตะผะฐ Fallback ะธ ะพะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ

### ะขัะตัััะพะฒะฝะตะฒะฐั ัะธััะตะผะฐ Fallback:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะฃะะะะะะฌ 1: Google Gemini                   โ
โ  - Model: gemini-2.0-flash-exp              โ
โ  - ะัะฟะพะปัะทัะตััั ะผะพะดะตะปั ะธะท .env              โ
โ  - Success rate: ~95%                       โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
               โ ะัะธะฑะบะฐ (5%)
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะฃะะะะะะฌ 2: OpenAI GPT                      โ
โ  - Model: ะธะท .env (gpt-4o / gpt-4o-mini)   โ
โ  - ะะฒัะพะผะฐัะธัะตัะบะพะต ะฟะตัะตะบะปััะตะฝะธะต              โ
โ  - ะฃะฒะตะดะพะผะปะตะฝะธะต ะฐะดะผะธะฝั ะพ fallback            โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
               โ ะัะธะฑะบะฐ (<1%)
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะฃะะะะะะฌ 3: ะะตะท AI ะฐะฝะฐะปะธะทะฐ                  โ
โ  - PDF ะพัะฟัะฐะฒะปัะตััั ั ะฑะฐะทะพะฒัะผ caption       โ
โ  - ะฃะฒะตะดะพะผะปะตะฝะธะต ะฐะดะผะธะฝั ะพ ะฟะพะปะฝะพะผ ะพัะบะฐะทะต       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพะด fallback:

```python
try:
    # ะะพะฟััะบะฐ 1: Google Gemini
    ai_insights = await self._generate_ai_insights(
        profile, month_data, prev_month_data, year, month, 'google'
    )
except Exception as e:
    logger.error(f"Primary AI provider (google) failed: {e}")

    # ะะพะฟััะบะฐ 2: OpenAI fallback
    if provider == 'google':
        try:
            logger.warning(f"Attempting fallback to OpenAI")
            ai_insights = await self._generate_ai_insights(
                ..., 'openai'
            )
            # ะฃะฒะตะดะพะผะปัะตะผ ะฐะดะผะธะฝะฐ
            await self._notify_admin_fallback(user_id, year, month, 'google', 'openai')
        except Exception as fallback_error:
            # ะฃะฒะตะดะพะผะปัะตะผ ะพ ะฟะพะปะฝะพะผ ะพัะบะฐะทะต
            await self._notify_admin_failure(user_id, year, month)
            raise
```

### ะฃัะปะพะฒะธั ะพัะบะฐะทะฐ ะพั ะณะตะฝะตัะฐัะธะธ:

```python
# ะะตะดะพััะฐัะพัะฝะพ ะดะฐะฝะฝัั
if month_data['total_expenses'] == 0 or len(month_data['expenses']) < 3:
    logger.info(f"Not enough data for insights: {len(expenses)} expenses")
    return None  # PDF ะพัะฟัะฐะฒะธััั ะฑะตะท AI ะฐะฝะฐะปะธะทะฐ
```

---

## ะฃะฒะตะดะพะผะปะตะฝะธั ะฐะดะผะธะฝะธัััะฐัะพัั

### 1. **ะัะฟะพะปัะทะพะฒะฐะฝ OpenAI Fallback**

**ะงะฐััะพัะฐ:** ะะฐะบัะธะผัะผ 1 ัะฐะท ะฒ ัะฐั (throttling)

**ะกะพะพะฑัะตะฝะธะต:**
```
โ๏ธ AI Provider Fallback

User: 881292737
Period: 10/2025
Primary provider failed: google
Fallback used: openai

Check logs for details.
```

**ะะพะด:**
```python
async def _notify_admin_fallback(self, user_id, year, month, primary, fallback):
    # Throttling: 1 ัะฐั ะผะตะถะดั ัะฒะตะดะพะผะปะตะฝะธัะผะธ
    key = f"{primary}_to_{fallback}"
    if key in _last_fallback_notification:
        time_since = (now - _last_fallback_notification[key]).total_seconds() / 3600
        if time_since < NOTIFICATION_THROTTLE_HOURS:
            return  # ะัะพะฟััะบะฐะตะผ

    _last_fallback_notification[key] = now
    await notify_admin(message, level='warning')
```

---

### 2. **ะะพะปะฝัะน ะพัะบะฐะท AI (ะพะฑะฐ ะฟัะพะฒะฐะนะดะตัะฐ)**

**ะงะฐััะพัะฐ:** ะะฐะบัะธะผัะผ 1 ัะฐะท ะฒ ัะฐั ะดะปั ะบะพะฝะบัะตัะฝะพะณะพ ะฟะตัะธะพะดะฐ

**ะกะพะพะฑัะตะฝะธะต:**
```
๐ด AI Insights Generation Failed

User: 881292737
Period: 10/2025
Status: All AI providers failed

User will receive monthly report without AI insights.
Check logs and AI service status.
```

**ะะพะด:**
```python
async def _notify_admin_failure(self, user_id, year, month):
    key = f"failure_{year}_{month}"

    # Throttling: 1 ัะฐั
    if key in _last_failure_notification:
        time_since = (now - _last_failure_notification[key]).total_seconds() / 3600
        if time_since < NOTIFICATION_THROTTLE_HOURS:
            return

    _last_failure_notification[key] = now
    await notify_admin(message, level='critical')
```

---

## ะัะพัะตัั ะดะตะฟะปะพั

### ะะฐ ะปะพะบะฐะปัะฝะพะน ะผะฐัะธะฝะต:

```bash
# 1. Commit ะธะทะผะตะฝะตะฝะธะน
git add bot/services/monthly_insights.py \
        bot/services/notifications.py \
        expense_bot/celery_tasks.py \
        expenses/models.py \
        expenses/migrations/0048_monthlyinsight.py

git commit -m "ะะพะฑะฐะฒะปะตะฝั AI-ะธะฝัะฐะนัั ะดะปั ะผะตัััะฝัั ะพััะตัะพะฒ"

# 2. Push ะฝะฐ GitHub
git push origin master
```

### ะะฐ ัะตัะฒะตัะต:

```bash
# 1. ะะพะดะบะปััะตะฝะธะต
ssh batman@80.66.87.178

# 2. ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ ะธ ะฟัะธะผะตะฝะตะฝะธะต ะผะธะณัะฐัะธะธ
cd /home/batman/expense_bot && \
git pull origin master && \
docker-compose down && \
docker-compose build --no-cache && \
docker-compose up -d && \
docker-compose exec expense_bot_web python manage.py migrate

# 3. ะัะพะฒะตัะบะฐ ะปะพะณะพะฒ
docker-compose logs -f expense_bot_celery_beat
docker-compose logs -f expense_bot_app
```

### โ๏ธ ะะะะขะะงะะกะะ ะะะะะ:

**ะะธะณัะฐัะธั ะฑะฐะทั ะดะฐะฝะฝัั ะะะฏะะะขะะะฌะะ!**

ะะตะท ะฒัะฟะพะปะฝะตะฝะธั `python manage.py migrate` ะฑะพั ะฑัะดะตั ะฟะฐะดะฐัั ั ะพัะธะฑะบะพะน:
```
relation "expenses_monthlyinsight" does not exist
```

---

## ะขะตััะธัะพะฒะฐะฝะธะต

### 1. ะขะตัั ะณะตะฝะตัะฐัะธะธ ะธะฝัะฐะนัะฐ (ะปะพะบะฐะปัะฝะพ)

**ะคะฐะนะป:** `test_monthly_insights.py`

```bash
cd C:/Users/_batman_/Desktop/expense_bot
venv/Scripts/python.exe test_monthly_insights.py
```

**ะัะพะฒะตััะตั:**
- ะะตะฝะตัะฐัะธั ะธะฝัะฐะนัะฐ ะดะปั ะพะบััะฑัั 2025
- ะกัะฐะฒะฝะตะฝะธะต ั ัะตะฝััะฑัะตะผ 2025
- ะะปะธะฝั ัะพะพะฑัะตะฝะธั (<1024 ัะธะผะฒะพะปะพะฒ)
- ะะพััะตะบัะฝะพััั ัะพัะผะฐัะธัะพะฒะฐะฝะธั

**ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั:**
```
โ ะะฝัะฐะนั ัะณะตะฝะตัะธัะพะฒะฐะฝ
๐ ะะปะธะฝะฐ: 858 ัะธะผะฒะพะปะพะฒ
โ ะะฟะธััะฒะฐะตััั ะฒ ะปะธะผะธั Telegram
```

---

### 2. ะขะตัั ะฑะตะท ะดะพัะพะดะพะฒ

**ะคะฐะนะป:** `test_insights_no_income.py`

```bash
venv/Scripts/python.exe test_insights_no_income.py
```

**ะัะพะฒะตััะตั:**
- ะัะพะผะฟั ะฝะต ัะพะดะตัะถะธั ัะฟะพะผะธะฝะฐะฝะธะน ะดะพัะพะดะพะฒ/ะฑะฐะปะฐะฝัะฐ ะฒ ะดะฐะฝะฝัั
- AI ะฟะพะปััะฐะตั ะธะฝััััะบัะธั ัะพะบััะธัะพะฒะฐัััั ัะพะปัะบะพ ะฝะฐ ัะฐััะพะดะฐั

**ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั:**
```
โ ะัะพะผะฟั ะบะพััะตะบัะฝัะน - ะดะพัะพะดั/ะฑะฐะปะฐะฝั ัะฟะพะผะธะฝะฐัััั ะฒ ะดะฐะฝะฝัั ัะพะปัะบะพ ะบะพะณะดะฐ ะตััั
```

---

### 3. ะัะพะฒะตัะบะฐ ะฝะฐ ัะตัะฒะตัะต

```bash
# ะะพะณะธ Celery ะทะฐะดะฐัะธ
docker-compose logs expense_bot_celery_beat | grep monthly

# ะัะพะฒะตัะบะฐ ัะฐัะฟะธัะฐะฝะธั
docker-compose exec expense_bot_celery_beat celery -A expense_bot inspect scheduled

# ะััะฝะพะน ะทะฐะฟััะบ ะทะฐะดะฐัะธ (ะดะปั ัะตััะฐ)
docker-compose exec expense_bot_web python manage.py shell
>>> from expense_bot.celery_tasks import send_monthly_reports
>>> send_monthly_reports()
```

---

## ะะทะฒะตััะฝัะต ะพะณัะฐะฝะธัะตะฝะธั

### 1. **ะะธะฝะธะผัะผ ะดะฐะฝะฝัั ะดะปั ะณะตะฝะตัะฐัะธะธ**

- ะขัะตะฑัะตััั ะผะธะฝะธะผัะผ **3 ััะฐัั** ะฒ ะผะตัััะต
- ะัะปะธ ะผะตะฝััะต - ะธะฝัะฐะนั ะะ ะณะตะฝะตัะธััะตััั
- PDF ะพัะฟัะฐะฒะปัะตััั ะฑะตะท AI ะฐะฝะฐะปะธะทะฐ

**ะะฑะพัะฝะพะฒะฐะฝะธะต:** ะะตะดะพััะฐัะพัะฝะพ ะดะฐะฝะฝัั ะดะปั ัะพะดะตัะถะฐัะตะปัะฝะพะณะพ ะฐะฝะฐะปะธะทะฐ

---

### 2. **ะขะพะปัะบะพ ัะฐััะพะดั ะฐะฝะฐะปะธะทะธัััััั**

- ะัะปะธ ั ะฟะพะปัะทะพะฒะฐัะตะปั **ะขะะะฌะะ ะดะพัะพะดั** (ะฝะตั ัะฐััะพะดะพะฒ) - ะธะฝัะฐะนั ะะ ะณะตะฝะตัะธััะตััั
- ะญัะพ ะฑะพั ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั ะะะกะฅะะะะ

**ะะฑะพัะฝะพะฒะฐะฝะธะต:** ะะตัะตะณะพ ะฐะฝะฐะปะธะทะธัะพะฒะฐัั ะฑะตะท ัะฐััะพะดะพะฒ

---

### 3. **ะะธะผะธั caption ะฒ Telegram**

- ะะฐะบัะธะผัะผ **1024 ัะธะผะฒะพะปะฐ** ะดะปั caption
- ะัะธ ะฟัะตะฒััะตะฝะธะธ - ะฐะฒัะพะผะฐัะธัะตัะบะฐั ะพะฑัะตะทะบะฐ ั "..."
- ะกัะตะดะฝัั ะดะปะธะฝะฐ ~850 ัะธะผะฒะพะปะพะฒ (ะทะฐะฟะฐั 174)

**ะะตัะตะฝะธะต:** ะะพะผะฟะฐะบัะฝะพะต ัะพัะผะฐัะธัะพะฒะฐะฝะธะต + ะดะธะฝะฐะผะธัะตัะบะฐั ะพะฑัะตะทะบะฐ

---

### 4. **ะัะฟัะฐะฒะบะฐ ัะพะปัะบะพ ั ะฐะบัะธะฒะฝะพะน ะฟะพะดะฟะธัะบะพะน**

- ะะตัััะฝัะต ะพััะตัั ั AI - **ะฟะปะฐัะฝะฐั ััะฝะบัะธั**
- ะัะพะฒะตัะบะฐ ะฟะพะดะฟะธัะบะธ ะฒ Celery ะทะฐะดะฐัะต
- ะะตะท ะฟะพะดะฟะธัะบะธ - ะพััะตั ะะ ะพัะฟัะฐะฒะปัะตััั

**ะคะธะปััั:**
```python
Q(subscriptions__is_active=True, subscriptions__end_date__gt=timezone.now()) |
Q(subscriptions__is_trial=True, subscriptions__is_active=True)
```

---

## ะัะดััะธะต ัะปัััะตะฝะธั

### 1. **ะะพะบะฐะปะธะทะฐัะธั (EN ัะทัะบ)**

**ะขะตะบััะตะต ัะพััะพัะฝะธะต:** ะะฐะฑะพัะฐะตั ัะพะปัะบะพ ะฝะฐ ััััะบะพะผ

**ะะปะฐะฝ:**
- ะะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั `profile.language_code`
- ะะดะฐะฟัะธัะพะฒะฐัั ะฟัะพะผะฟั ะฟะพะด EN
- ะะตัะตะฒะตััะธ ัะพัะผะฐัะธัะพะฒะฐะฝะธะต ัะตะบััะฐ

---

### 2. **ะะตััะพะฝะฐะปะธะทะฐัะธั ะฟัะพะผะฟัะฐ**

**ะะดะตั:** ะฃัะธััะฒะฐัั ะฟัะพัะธะปั ะฟะพะปัะทะพะฒะฐัะตะปั

- ะกะตะผะตะนะฝัะน ะฑัะดะถะตั vs ะธะฝะดะธะฒะธะดัะฐะปัะฝัะน
- ะกััะดะตะฝั vs ัะฐะฑะพัะฐััะธะน
- ะะฐะทะฝัะต ัะตะปะธ (ัะบะพะฝะพะผะธั vs ะฟะปะฐะฝะธัะพะฒะฐะฝะธะต)

---

### 3. **ะัะพะณะฝะพะทั ะฝะฐ ัะปะตะดัััะธะน ะผะตััั**

**ะะดะตั:** ะัะตะดัะบะฐะทะฐะฝะธะต ัะฐััะพะดะพะฒ

```
๐ ะัะพะณะฝะพะท ะฝะฐ ะฝะพัะฑัั:
ะะถะธะดะฐะตะผัะต ัะฐััะพะดั: ~32 000 โฝ
ะะฐ ะพัะฝะพะฒะต ััะตะฝะดะพะฒ ะฟะพัะปะตะดะฝะธั 3 ะผะตัััะตะฒ
```

---

### 4. **ะะฝะพะฝะธะผะฝะฐั ััะฐัะธััะธะบะฐ**

**ะะดะตั:** ะกัะฐะฒะฝะตะฝะธะต ั ะดััะณะธะผะธ ะฟะพะปัะทะพะฒะฐัะตะปัะผะธ

```
๐ ะะฐัะธ ัะฐััะพะดั ะฝะฐ ะฟัะพะดัะบัั (18 500โฝ) ะฝะฐ 15% ะฝะธะถะต ััะตะดะฝะตะณะพ
ะฟะพ ะฟะพะปัะทะพะฒะฐัะตะปัะผ ั ะฟะพัะพะถะธะผ ะดะพัะพะดะพะผ
```

---

## ะัะพะณะธ ัะตะฐะปะธะทะฐัะธะธ

### โ ะงัะพ ัะดะตะปะฐะฝะพ:

1. **ะะพะดะตะปั ะะ** - `MonthlyInsight` ะดะปั ะบะตัะธัะพะฒะฐะฝะธั ะธะฝัะฐะนัะพะฒ
2. **ะกะตัะฒะธั** - `MonthlyInsightsService` ั ะฟะพะปะฝะพะน ะปะพะณะธะบะพะน ะณะตะฝะตัะฐัะธะธ
3. **ะะฝัะตะณัะฐัะธั** - ะ `NotificationService` ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ะพัะฟัะฐะฒะบะธ
4. **ะัะพะฒะตัะบะฐ ะฟะพะดะฟะธัะบะธ** - ะคะธะปัััะฐัะธั ะฒ Celery ะทะฐะดะฐัะต
5. **ะะดะฐะฟัะธะฒะฝัะน ะบะพะฝัะตะฝั** - ะกะบัััะธะต ะดะพัะพะดะพะฒ/ะฑะฐะปะฐะฝัะฐ ะฟัะธ ะธั ะพััััััะฒะธะธ
6. **Fallback ัะธััะตะผะฐ** - Google โ OpenAI โ ะฑะตะท AI
7. **ะฃะฒะตะดะพะผะปะตะฝะธั ะฐะดะผะธะฝั** - ะก throttling ะฟัะพัะธะฒ ัะฟะฐะผะฐ
8. **ะขะตััั** - ะะพะบะฐะปัะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต

### ๐ ะกัะฐัะธััะธะบะฐ:

- **ะะพะฒัะต ัะฐะนะปั:** 1 (`bot/services/monthly_insights.py`)
- **ะะทะผะตะฝะตะฝะฝัะต ัะฐะนะปั:** 3 (notifications.py, celery_tasks.py, models.py)
- **ะะธะณัะฐัะธะธ ะะ:** 1 (`0048_monthlyinsight.py`)
- **ะกััะพะบ ะบะพะดะฐ:** ~640 (ัะตัะฒะธั) + ะธะฝัะตะณัะฐัะธั
- **ะะพะผะผะธัั:** 3
  - `9f160fc` - ะัะฝะพะฒะฝะฐั ััะฝะบัะธะพะฝะฐะปัะฝะพััั
  - `0f984e1` - ะะตัะฐะบัะพัะธะฝะณ Top-5
  - `39b28c5` - ะฃะปัััะตะฝะธั (ะดะพัะพะดั/ะฟะพะดะฟะธัะบะฐ)

### ๐ฏ ะะตะทัะปััะฐั:

**ะะพะปะฝะพัััั ัะฐะฑะพัะฐั ัะธััะตะผะฐ AI-ะธะฝัะฐะนัะพะฒ**, ะธะฝัะตะณัะธัะพะฒะฐะฝะฝะฐั ะฒ ะผะตัััะฝัะต ะพััะตัั, ั ะฝะฐะดะตะถะฝัะผ fallback ะธ ะฟัะพะฒะตัะบะพะน ะฟะพะดะฟะธัะบะธ.

---

**ะะพะบัะผะตะฝั ัะพะทะดะฐะฝ:** 2025-10-09
**ะะพัะปะตะดะฝะตะต ะพะฑะฝะพะฒะปะตะฝะธะต:** 2025-10-09
**ะะตััะธั:** 1.0
