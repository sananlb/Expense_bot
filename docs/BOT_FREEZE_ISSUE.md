# Проблема зависания бота для определенных пользователей

## Описание проблемы
Бот периодически перестает отвечать определенным пользователям. Проблема повторяется у пользователя с telegram_id: 5100223291.

## Симптомы
1. Бот не реагирует на команды пользователя
2. Не отвечает на текстовые сообщения
3. Не реагирует на inline-кнопки
4. Проблема решается только через сброс состояния FSM

## История инцидентов

### Пользователь 5100223291
- **Первый инцидент**: Дата неизвестна, решено сбросом состояния
- **Второй инцидент**: 05.09.2025, бот снова завис

## Возможные причины

### 1. Зависание в FSM состояниях
- Пользователь может застрять в состоянии, которое не обрабатывает определенные типы сообщений
- Отсутствие fallback обработчиков для некоторых состояний
- Неправильная очистка состояния при ошибках

### 2. Проблемы с middleware
- Activity tracker может блокировать обработку
- Проблемы с асинхронностью в middleware

### 3. Проблемы с обработчиками
- Необработанные исключения в handlers
- Бесконечные циклы в обработке
- Deadlock при работе с БД

### 4. Проблемы с Redis/FSM Storage
- Поврежденные данные в Redis
- Неправильная сериализация состояния
- Истечение TTL для ключей состояния

## Диагностика

### Шаги для диагностики:

1. **Проверка текущего состояния пользователя в Redis**
```python
import redis
r = redis.Redis(host='localhost', port=6379, db=0)
user_id = 5100223291

# Получаем все ключи для пользователя
keys = r.keys(f"*{user_id}*")
for key in keys:
    print(f"{key}: {r.get(key)}")
```

2. **Проверка логов бота**
```bash
# На сервере
docker logs expense_bot_app --tail 100 | grep "5100223291"
```

3. **Проверка состояния в БД**
```sql
SELECT * FROM users_profile WHERE telegram_id = 5100223291;
```

## Временное решение

### Сброс состояния пользователя:
```python
from aiogram.fsm.storage.redis import RedisStorage
from aiogram.fsm.context import FSMContext

async def reset_user_state(user_id: int):
    storage = RedisStorage(redis=redis_client)
    state = FSMContext(
        storage=storage,
        key=StorageKey(bot_id=bot.id, user_id=user_id, chat_id=user_id)
    )
    await state.clear()
```

## Постоянные решения (TODO)

### 1. Добавить глобальный fallback handler
- Обработчик для любых сообщений в любом состоянии
- Автоматический сброс состояния при многократных неудачных попытках

### 2. Добавить timeout для состояний
- Автоматический сброс состояния через N минут неактивности
- Middleware для отслеживания последней активности

### 3. Улучшить обработку ошибок
- Логирование всех необработанных исключений
- Автоматический сброс состояния при критических ошибках

### 4. Добавить мониторинг
- Метрики по зависшим состояниям
- Алерты при длительном нахождении в одном состоянии

### 5. Добавить команду /reset
- Принудительный сброс состояния пользователем
- Доступна всегда, независимо от текущего состояния

## Код для анализа

### Критические места в коде:
1. `bot/middleware/activity_tracker.py` - может блокировать обработку
2. `bot/routers/expense.py` - сложные FSM состояния при редактировании
3. `bot/routers/income.py` - аналогичные проблемы с доходами
4. `bot/utils/state_utils.py` - функции работы с состояниями

### Проблемные FSM состояния:
- `EditExpenseForm.*` - редактирование трат
- `EditIncomeForm.*` - редактирование доходов
- `ExpenseForm.*` - добавление трат
- `IncomeForm.*` - добавление доходов
- `RecurringPaymentForm.*` - регулярные платежи

## План действий

1. **Немедленные действия**:
   - Добавить глобальный /reset команду
   - Улучшить логирование состояний

2. **Краткосрочные улучшения**:
   - Добавить timeout для всех FSM состояний
   - Добавить fallback handlers

3. **Долгосрочные улучшения**:
   - Рефакторинг FSM логики
   - Добавить полноценный мониторинг
   - Автоматическое восстановление

## Обновления

### 05.09.2025
- Создан документ
- Начат анализ проблемы
- Пользователь 5100223291 снова столкнулся с проблемой