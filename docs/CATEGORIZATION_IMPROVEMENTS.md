# Улучшения системы категоризации расходов

## Обзор изменений
Реализована улучшенная система категоризации расходов с поддержкой множественного ввода, автоматического исправления опечаток и поддержкой английского языка.

## Основные компоненты

### 1. Новый модуль expense_categorizer.py
Создан новый модуль `bot/utils/expense_categorizer.py` со следующим функционалом:

#### Исправление опечаток
- **Ручной словарь** для частых опечаток (вада→вода, кофэ→кофе и т.д.)
- **Интеграция с pyspellchecker** для автоматического исправления
- Поддержка русского и английского языков
- Автоматическое определение языка текста

#### Множественный ввод
- Разбиение текста на отдельные элементы (кофе, вода и чебурек → [кофе, вода, чебурек])
- Поддержка различных разделителей: "и", "да", "плюс", ",", "+"
- Анализ каждого слова отдельно

#### Улучшенная категоризация
- Точное сопоставление слов вместо поиска подстроки
- Система весов для разных типов совпадений
- Выбор категории по максимальному количеству совпадений
- Расчет уверенности на основе количества совпадений

### 2. Библиотека pyspellchecker
Установлена и интегрирована библиотека для проверки правописания:
```bash
pip install pyspellchecker
```

#### Возможности:
- Автоматическое исправление опечаток
- Поддержка русского языка (`language='ru'`)
- Поддержка английского языка (`language='en'`)
- Возможность добавления пользовательских слов в словарь

### 3. Поддержка английского языка

#### Автоматическое определение языка
```python
def detect_language(text: str) -> str:
    # Подсчет кириллических и латинских символов
    # Возвращает 'ru' или 'en'
```

#### Английские категории
- groceries (продукты)
- cafe (кафе)
- transport (транспорт)
- entertainment (развлечения)
- health (здоровье)
- clothes (одежда)
- utilities (коммунальные услуги)
- other (другое)

### 4. Интеграция с expense_parser_improved.py
Обновлен основной парсер для использования новой системы категоризации:
- Автоматическое исправление опечаток перед парсингом
- Использование улучшенной функции категоризации
- Сохранение обратной совместимости

## Примеры использования

### Русский язык
```python
from bot.utils.expense_categorizer import categorize_expense

# Множественный ввод с опечатками
text = "кофэ вада и чибурек"
category, confidence, corrected = categorize_expense(text)
# Результат: category='кафе', corrected='кофе вода и чебурек'

# Автоматическое исправление
text = "прадукты в магазине"
category, confidence, corrected = categorize_expense(text)
# Результат: category='продукты', corrected='продукты в магазине'
```

### Английский язык
```python
# Английский текст
text = "coffee and burger"
category, confidence, corrected = categorize_expense(text, language='en')
# Результат: category='cafe'

# Автоматическое определение языка
text = "groceries at walmart"
category, confidence, corrected = categorize_expense(text)
# Результат: category='groceries', language='en' (автоматически определен)
```

## Преимущества новой системы

1. **Точность**: Исправление опечаток повышает точность категоризации
2. **Множественный ввод**: Правильная обработка нескольких товаров в одном сообщении
3. **Мультиязычность**: Поддержка русского и английского языков
4. **Автономность**: Работает без подключения к AI API
5. **Расширяемость**: Легко добавлять новые категории и ключевые слова

## Тестирование

Созданы тестовые скрипты:
- `test_categorization.py` - тестирование русского языка
- `test_spellcheck.py` - тестирование исправления опечаток
- `test_english_spellcheck.py` - тестирование английского языка

## Зависимости

Добавлена новая зависимость в requirements.txt:
```
pyspellchecker==0.8.3
```

## Обратная совместимость

Все изменения полностью совместимы с существующим кодом. Старые функции продолжают работать, но используют улучшенную логику внутри.