# Архитектура проекта ExpenseBot

## Общий обзор

ExpenseBot построен на основе микросервисной архитектуры с использованием Django как основного backend фреймворка и aiogram для взаимодействия с Telegram Bot API. Проект поддерживает как синхронное (Django), так и асинхронное (aiogram) выполнение кода.

## Компоненты системы

### 1. Telegram Bot Service (aiogram)
- **Местоположение**: `/bot/`
- **Назначение**: Обработка входящих сообщений от пользователей Telegram
- **Основные модули**:
  - `main.py` - точка входа для бота
  - `routers/` - обработчики команд и сообщений
  - `middlewares/` - промежуточное ПО для авторизации и локализации
  - `services/` - бизнес-логика бота
  - `utils/` - вспомогательные утилиты

### 2. Django Backend Service
- **Местоположение**: `/expense_bot/` и `/expenses/`
- **Назначение**: REST API, админ-панель, управление данными
- **Основные модули**:
  - `models.py` - модели данных
  - `admin.py` - административный интерфейс
  - `services/` - бизнес-логика Django
  - `migrations/` - миграции базы данных

### 3. Database Service
- **База данных**: PostgreSQL (production) / SQLite (development)
- **Модели**: Пользователи, расходы, категории, кешбэки, настройки
- **Местоположение**: `/database/models.py`

### 4. Celery Task Queue
- **Назначение**: Асинхронная обработка задач
- **Задачи**:
  - Генерация PDF отчетов
  - Отправка уведомлений
  - Обработка загруженных файлов
  - Периодические задачи (месячные сводки)

### 5. Redis Cache
- **Назначение**: Кеширование данных и очередь задач для Celery
- **Хранение**:
  - Сессии пользователей
  - Временные данные
  - Очередь задач

## Схема взаимодействия

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Telegram      │◄──►│   Bot Service    │◄──►│  Django API     │
│     Users       │    │   (aiogram)      │    │    Service      │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                              │                          │
                              ▼                          ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │     Redis       │    │   PostgreSQL    │
                       │   (Cache/Queue) │    │   (Database)    │
                       └─────────────────┘    └─────────────────┘
                              │                          ▲
                              ▼                          │
                       ┌─────────────────┐               │
                       │     Celery      │───────────────┘
                       │  (Task Queue)   │
                       └─────────────────┘
```

## Структура файлов

```
expense_bot/
├── bot/                          # Telegram Bot (aiogram)
│   ├── main.py                   # Точка входа бота
│   ├── routers/                  # Обработчики команд
│   │   ├── start.py              # Команда /start
│   │   ├── menu.py               # Главное меню
│   │   ├── expense.py            # Управление расходами
│   │   ├── category.py           # Управление категориями
│   │   ├── cashback.py           # Система кешбэков
│   │   ├── reports.py            # Отчеты и аналитика
│   │   └── settings.py           # Настройки пользователя
│   ├── middlewares/              # Промежуточное ПО
│   │   ├── database.py           # Подключение к БД
│   │   └── localization.py       # Локализация
│   ├── services/                 # Бизнес-логика
│   │   ├── expense.py            # Сервис расходов
│   │   ├── user.py               # Сервис пользователей
│   │   └── cashback.py           # Сервис кешбэков
│   ├── utils/                    # Утилиты
│   │   ├── commands.py           # Парсинг команд
│   │   └── expense_parser.py     # Парсинг расходов
│   └── texts.py                  # Локализация текстов
├── expense_bot/                  # Django проект
│   ├── settings.py               # Настройки Django
│   ├── urls.py                   # URL маршруты
│   ├── wsgi.py                   # WSGI конфигурация
│   └── celery.py                 # Настройки Celery
├── expenses/                     # Django приложение
│   ├── models.py                 # Модели данных
│   ├── admin.py                  # Админ-панель
│   ├── services/                 # Бизнес-логика Django
│   ├── migrations/               # Миграции БД
│   └── templates/                # HTML шаблоны
├── database/                     # Модели БД
│   └── models.py                 # Общие модели
├── requirements.txt              # Зависимости Python
├── manage.py                     # Django управление
├── run_bot.py                    # Запуск бота
└── start_redis_celery.py         # Запуск Celery
```

## Архитектурные решения

### 1. Разделение Bot и Web сервисов

**Причина**: Telegram Bot требует асинхронного выполнения (aiogram), в то время как Django ORM работает синхронно.

**Решение**: 
- Bot Service использует aiogram для асинхронной обработки сообщений
- Django API предоставляет синхронные REST endpoints
- Общие модели вынесены в отдельный модуль

### 2. Единая база данных

**Причина**: Необходимость консистентности данных между ботом и админ-панелью.

**Решение**: 
- Общие модели Django ORM
- Bot Service использует Django ORM через синхронные вызовы
- Администрирование через Django Admin

### 3. Система очередей

**Причина**: Некоторые операции (генерация PDF, отправка уведомлений) требуют времени.

**Решение**:
- Celery с Redis backend
- Асинхронная обработка тяжелых задач
- Периодические задачи через Celery Beat

### 4. Кеширование

**Причина**: Оптимизация производительности и снижение нагрузки на БД.

**Решение**:
- Redis для кеширования часто используемых данных
- Кеширование результатов API запросов
- Сессии пользователей в Redis

## Паттерны проектирования

### 1. Repository Pattern
Каждая сущность имеет свой сервисный слой:
- `ExpenseService` - операции с расходами
- `CategoryService` - операции с категориями  
- `CashbackService` - операции с кешбэками
- `UserService` - операции с пользователями

### 2. Middleware Pattern
Промежуточное ПО для обработки запросов:
- `DatabaseMiddleware` - инициализация соединений с БД
- `LocalizationMiddleware` - определение языка пользователя

### 3. Strategy Pattern
Различные стратегии обработки сообщений:
- Обработка команд
- Обработка текстовых сообщений (расходы)
- Обработка callback данных

### 4. Factory Pattern
Фабрики для создания объектов:
- Создание клавиатур
- Создание сообщений
- Создание отчетов

## Масштабируемость

### Горизонтальное масштабирование
- Bot Service можно запускать в нескольких экземплярах
- Django API поддерживает load balancing
- Celery workers масштабируются независимо
- Redis Cluster для распределенного кеширования

### Вертикальное масштабирование
- Оптимизация запросов к БД через индексы
- Кеширование на уровне приложения
- Асинхронная обработка тяжелых операций

## Безопасность

### Аутентификация
- Telegram User ID как основной идентификатор
- Валидация запросов через Telegram API
- JWT токены для внутренних сервисов

### Защита данных
- Валидация всех входящих данных
- Защита от SQL инъекций через Django ORM
- Логирование всех операций
- Шифрование конфиденциальных данных

### API безопасность
- Rate limiting для API endpoints
- CORS настройки
- Валидация прав доступа

## Мониторинг и логирование

### Логирование
```python
# Структура логов
logs/
├── bot.log          # Логи бота
├── django.log       # Логи Django
├── celery.log       # Логи Celery
└── errors.log       # Логи ошибок
```

### Метрики
- Количество обработанных сообщений
- Время отклика API
- Использование памяти и CPU
- Количество активных пользователей

## Развертывание

### Development
```bash
# Запуск Redis
redis-server

# Запуск Celery
celery -A expense_bot worker -l info

# Запуск Django
python manage.py runserver

# Запуск бота
python run_bot.py
```

### Production
- Docker контейнеры для каждого сервиса
- Nginx как reverse proxy
- Supervisor для управления процессами
- PostgreSQL как основная БД