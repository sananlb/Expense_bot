<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coins - –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç</title>
    <script>{{ chart_js_code }}</script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            background-color: #f0f0f0 !important;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f0f0 !important;
            color: #1a1a1a;
            line-height: 1.6;
            font-size: 19px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px 15px;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .brand-name {
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .report-period {
            font-size: 20px;
            opacity: 0.9;
            font-weight: 300;
        }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .horizontal-metrics {
            display: flex;
            justify-content: space-between;
            background: white;
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }
        
        .metric-item {
            flex: 1;
            text-align: center;
        }
        
        .metric-item:not(:last-child) {
            border-right: 1px solid #e5e7eb;
            padding-right: 16px;
            margin-right: 16px;
        }
        
        
        .summary-card {
            background: white;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            text-align: center;
            transition: transform 0.2s;
        }
        
        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .summary-value {
            font-size: 29px;
            font-weight: 700;
            color: #667eea;
            margin: 4px 0;
        }
        
        .summary-label {
            font-size: 17px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .summary-trend {
            font-size: 14px;
            margin-top: 2px;
        }
        
        .trend-up {
            color: #ef4444;
        }
        
        .trend-down {
            color: #10b981;
        }
        
        .cashback-value {
            color: #10b981;
        }
        
        /* Charts Section */
        .chart-section {
            background: white;
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        
        .chart-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
        }
        
        .chart-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1a1a1a;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .charts-grid .chart-section {
            background: white;
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .chart-container {
            position: relative;
            height: 180px;
        }
        
        .chart-container.pie-chart {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            filter: drop-shadow(3px 3px 8px rgba(0, 0, 0, 0.15));
        }
        
        /* Categories List */
        .categories-list {
            margin-top: 10px;
        }
        
        .flexible-chart-section {
            min-height: 420px;
            max-height: none;
            overflow: visible;
        }
        
        .flexible-categories {
            min-height: 280px;
            max-height: none;
            overflow-y: visible;
            overflow-x: hidden;
        }
        
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 18px;
        }
        
        .category-item:last-child {
            border-bottom: none;
        }
        
        .category-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .category-right {
            text-align: left;
            padding-left: 10px;
        }
        
        .category-color {
            width: 10px;
            height: 28px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        
        .category-name {
            font-weight: 400;
            font-size: 18px;
        }
        
        .category-amount {
            font-weight: 400;
            color: #667eea;
            font-size: 19px;
        }
        
        .category-cashback {
            font-size: 14px;
            color: #10b981;
            margin-top: 1px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 10px;
            color: #6b7280;
            font-size: 15px;
        }
        
        @media print {
            body {
                background-color: #f0f0f0 !important;
            }
            .header {
                box-shadow: none;
                page-break-inside: avoid;
                break-inside: avoid;
            }
            .chart-section {
                box-shadow: none;
                page-break-inside: avoid;
                break-inside: avoid;
            }
            .summary-cards, .horizontal-metrics {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            .flexible-chart-section {
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }
        
        /* Prevent page breaks for all sections */
        .chart-section, .header, .summary-cards, .horizontal-metrics, .flexible-chart-section {
            page-break-inside: avoid;
            break-inside: avoid;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-container">
                {% if logo_base64 %}
                <img src="data:image/png;base64,{{ logo_base64 }}" alt="Coins Logo" class="logo">
                {% endif %}
                <h1 class="brand-name">Coins</h1>
            </div>
            <p class="report-period">{% if household_mode %}üè† {{ household_name }} ‚Äî {% endif %}{{ report_for_period }} {{ period }}</p>
        </div>
        
        <!-- Summary Cards - Simplified layout -->
        {% if has_incomes %}
        <!-- Layout with both expenses and incomes -->
        <div class="horizontal-metrics">
            <div class="metric-item">
                <p class="summary-label">{{ total_spent }}</p>
                <p class="summary-value">{{ total_amount }} ‚ÇΩ <span style="color: #10b981; font-size: 13px;">({{ total_cashback }} ‚ÇΩ)</span></p>
            </div>
            <div class="metric-item">
                <p class="summary-label">{{ total_income }}</p>
                <p class="summary-value" style="color: #10b981;">{{ income_total_amount }} ‚ÇΩ</p>
            </div>
            <div class="metric-item">
                <p class="summary-label">{{ balance }}</p>
                <p class="summary-value" style="color: #4b5563;">{{ net_balance }} ‚ÇΩ</p>
            </div>
        </div>
        {% else %}
        <!-- Layout for expenses only - old format -->
        <div class="summary-cards">
            <div class="summary-card">
                <p class="summary-label">{{ total_spent }}</p>
                <p class="summary-value">{{ total_amount }} ‚ÇΩ</p>
            </div>
            <div class="summary-card">
                <p class="summary-label">{{ expense_count }}</p>
                <p class="summary-value">{{ total_count }}</p>
            </div>
            <div class="summary-card">
                <p class="summary-label">{{ monthly_cashback }}</p>
                <p class="summary-value cashback-value">{{ total_cashback }} ‚ÇΩ</p>
            </div>
        </div>
        {% endif %}
        
        {% if has_incomes %}
        <!-- Charts with flexible height when incomes exist -->
        <div class="chart-section flexible-chart-section" style="display: flex; align-items: stretch; gap: 20px; margin-bottom: 15px;">
            <div style="flex: 0 0 180px; display: flex; flex-direction: column; margin-left: -10px;">
                <h2 class="chart-title" style="text-align: left; margin-bottom: 12px; margin-top: 36px;">{{ expenses_by_category }}</h2>
                <div class="chart-container pie-chart" style="display: flex; align-items: center; justify-content: center; margin-top: auto; margin-bottom: auto; height: 220px;">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
            
            <div style="flex: 1; display: flex; align-items: center;">
                <div class="categories-list flexible-categories" style="width: 100%;">
                    {% for cat in categories %}
                    <div class="category-item">
                        <div class="category-info">
                            <div class="category-color" style="background: {{ cat.color }}"></div>
                            <span class="category-name">{{ cat.icon }} {{ cat.name }}</span>
                        </div>
                        <div class="category-right">
                            <div class="category-amount">{{ cat.amount_formatted }} ‚ÇΩ <span class="category-cashback" style="margin-left:8px; color:#10b981;">+{{ cat.cashback_formatted }} ‚ÇΩ</span></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% else %}
        <!-- Charts with unified format for expenses only -->
        <div class="chart-section flexible-chart-section" style="display: flex; align-items: stretch; gap: 20px; margin-bottom: 15px;">
            <div style="flex: 0 0 180px; display: flex; flex-direction: column; margin-left: -10px;">
                <h2 class="chart-title" style="text-align: left; margin-bottom: 12px; margin-top: 36px;">{{ expenses_by_category }}</h2>
                <div class="chart-container pie-chart" style="display: flex; align-items: center; justify-content: center; margin-top: auto; margin-bottom: auto; height: 220px;">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
            
            <div style="flex: 1; display: flex; align-items: center;">
                <div class="categories-list flexible-categories" style="width: 100%;">
                    {% for cat in categories %}
                    <div class="category-item">
                        <div class="category-info">
                            <div class="category-color" style="background: {{ cat.color }}"></div>
                            <span class="category-name">{{ cat.icon }} {{ cat.name }}</span>
                        </div>
                        <div class="category-right">
                            <div class="category-amount">{{ cat.amount_formatted }} ‚ÇΩ <span class="category-cashback" style="margin-left:8px; color:#10b981;">+{{ cat.cashback_formatted }} ‚ÇΩ</span></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Daily Expenses Chart -->
        <div class="chart-section">
            <h2 class="chart-title">{{ daily_expenses }}</h2>
            <div class="chart-container" style="height: 230px;">
                <canvas id="barChart"></canvas>
            </div>
        </div>
        
        {% if has_incomes %}
        <!-- Income Charts when both expenses and incomes exist -->
        {% if income_categories %}
        <div class="chart-section flexible-chart-section" style="display: flex; align-items: stretch; gap: 20px; margin-bottom: 15px; margin-top: 30px;">
            <div style="flex: 0 0 180px; display: flex; flex-direction: column; margin-left: -10px;">
                <h2 class="chart-title" style="text-align: left; margin-bottom: 12px; margin-top: 36px; color: #1a1a1a;">{{ income_by_category }}</h2>
                <div class="chart-container pie-chart" style="display: flex; align-items: center; justify-content: center; margin-top: auto; margin-bottom: auto; height: 220px;">
                    <canvas id="incomePieChart"></canvas>
                </div>
            </div>
            
            <div style="flex: 1; display: flex; align-items: center;">
                <div class="categories-list flexible-categories" style="width: 100%;">
                    {% for cat in income_categories %}
                    <div class="category-item">
                        <div class="category-info">
                            <div class="category-color" style="background: {{ cat.color }}"></div>
                            <span class="category-name">{{ cat.icon }} {{ cat.name }}</span>
                        </div>
                        <div class="category-right">
                            <div class="category-amount" style="color: #10b981;">{{ cat.amount_formatted }} ‚ÇΩ</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Income Daily Chart -->
        <div class="chart-section">
            <h2 class="chart-title">{{ daily_income }}</h2>
            <div class="chart-container" style="height: 250px;">
                <canvas id="incomeChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- Bottom Summary: Previous Months -->
        <div class="chart-section">
            <h2 class="chart-title">{{ monthly_statistics }}</h2>
            {% if prev_summaries %}
            <table style="width:100%; border-collapse: collapse; margin-top: 8px; font-size: 15px; table-layout: fixed;">
                <thead>
                    <tr>
                        <th style="text-align:left; padding: 4px 4px 8px 4px; color:#6b7280; font-weight:600; width: 20%; border-bottom: 1px solid #f0f0f0;">{{ month }}</th>
                        <th style="text-align:right; padding: 4px 4px 8px 4px; color:#6b7280; font-weight:600; width: 26.67%; border-bottom: 1px solid #f0f0f0;">{{ expenses }}</th>
                        <th style="text-align:right; padding: 4px 4px 8px 4px; color:#6b7280; font-weight:600; width: 26.67%; border-bottom: 1px solid #f0f0f0;">{{ income }}</th>
                        <th style="text-align:right; padding: 4px 4px 8px 4px; color:#6b7280; font-weight:600; width: 26.66%; border-bottom: 1px solid #f0f0f0;">–ë–∞–ª–∞–Ω—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for m in prev_summaries %}
                    <tr>
                        <td style="padding: 4px;">{{ m.label }}</td>
                        <td style="padding: 4px; text-align:right;">
                            {{ m.expenses }}
                        </td>
                        <td style="padding: 4px; text-align:right;">
                            {{ m.incomes }}
                        </td>
                        <td style="padding: 4px; text-align:right;">
                            {{ m.balance }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color: #6b7280; text-align: center; padding: 20px;">–î–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –º–µ—Å—è—Ü–∞–º –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã</p>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>{{ generated_by }}</p>
        </div>
    </div>
    
    <script>
        // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        const categoriesData = {{ categories_json | safe }};
        const dailyData = {{ daily_json | safe }};
        
        // Pie Chart
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        
        // Calculate percentages for data labels
        const totalAmount = categoriesData.reduce((sum, c) => sum + c.amount, 0);
        const percentages = categoriesData.map(c => ((c.amount / totalAmount) * 100).toFixed(0));
        
        new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: categoriesData.map(c => c.icon + ' ' + c.name),
                datasets: [{
                    data: categoriesData.map(c => c.amount),
                    backgroundColor: categoriesData.map(c => c.color),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false  // –û—Ç–∫–ª—é—á–∞–µ–º –ª–µ–≥–µ–Ω–¥—É –ø–æ–¥ –¥–∏–∞–≥—Ä–∞–º–º–æ–π
                    },
                    datalabels: {
                        color: '#f3f4f6',  // Almost white color
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        formatter: function(value, context) {
                            const percentage = percentages[context.dataIndex];
                            // Only show percentage if it's > 4%
                            return percentage > 4 ? percentage + '%' : '';
                        },
                        display: function(context) {
                            const percentage = percentages[context.dataIndex];
                            return percentage > 4;
                        }
                    }
                }
            },
            plugins: [{
                id: 'datalabels',
                afterDatasetsDraw: function(chart) {
                    const ctx = chart.ctx;
                    chart.data.datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        meta.data.forEach((element, index) => {
                            const percentage = percentages[index];
                            if (percentage > 4) {
                                // Get the position for the label - even further from outer edge
                                const model = element;
                                const midAngle = (model.startAngle + model.endAngle) / 2;
                                const labelRadius = model.innerRadius + (model.outerRadius - model.innerRadius) * 0.6;
                                const x = model.x + Math.cos(midAngle) * labelRadius;
                                const y = model.y + Math.sin(midAngle) * labelRadius;
                                
                                // Draw the percentage
                                ctx.fillStyle = '#f3f4f6';
                                ctx.font = 'bold 16px sans-serif';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(percentage + '%', x, y);
                            }
                        });
                    });
                }
            }]
        });
        
        // Bar Chart - Stacked by categories
        const barCtx = document.getElementById('barChart').getContext('2d');
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö —Å—Ç–æ–ª–±–∏–∫–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        const categoryDatasets = [];
        if (dailyData.categoryBreakdown) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            categoriesData.forEach((cat, index) => {
                categoryDatasets.push({
                    label: cat.icon + ' ' + cat.name,
                    data: dailyData.categoryBreakdown[cat.name] || new Array(dailyData.days.length).fill(0),
                    backgroundColor: cat.color,
                    borderWidth: 0,
                    barPercentage: 0.8
                });
            });
        } else {
            // Fallback –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
            categoryDatasets.push({
                label: '{{ expenses }}',
                data: dailyData.expenses,
                backgroundColor: '#667eea',
                borderWidth: 0
            });
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–µ—à–±—ç–∫ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π dataset
        if (dailyData.cashback && dailyData.cashback.some(v => v !== 0)) {
            categoryDatasets.push({
                label: '–ö–µ—à–±—ç–∫',
                data: dailyData.cashback.map(v => -Math.abs(v)), // –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–Ω–∏–∑
                backgroundColor: '#10b981',
                borderWidth: 0
            });
        }
        
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: dailyData.days,
                datasets: categoryDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false  // –û—Ç–∫–ª—é—á–∞–µ–º –ª–µ–≥–µ–Ω–¥—É, —Ç–∞–∫ –∫–∞–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω—ã –≤—ã—à–µ
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = Math.abs(context.parsed.y);
                                return context.dataset.label + ': ' + value.toLocaleString('ru-RU') + ' ‚ÇΩ';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 0,
                            callback: function(value, index) {
                                // Show every 5th day
                                return (index + 1) % 5 === 0 ? index + 1 : '';
                            }
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return Math.abs(value).toLocaleString('ru-RU') + ' ‚ÇΩ';
                            }
                        }
                    }
                }
            },
            plugins: [{
                beforeDraw: function(chart) {
                    const ctx = chart.ctx;
                    ctx.save();
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.15)';
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetX = 3;
                    ctx.shadowOffsetY = 3;
                },
                afterDraw: function(chart) {
                    const ctx = chart.ctx;
                    ctx.restore();
                }
            }]
        });
        
        // Income Charts (if there are incomes)
        {% if has_incomes %}
        const incomeCategories = {{ income_categories_json | safe }};
        const dailyIncomes = {{ daily_incomes_json | safe }};
        
        // Income Pie Chart
        {% if income_categories %}
        if (incomeCategories && incomeCategories.length > 0) {
            const incomePieCtx = document.getElementById('incomePieChart').getContext('2d');
            
            // Calculate percentages for income data labels
            const incomeTotalAmount = incomeCategories.reduce((sum, c) => sum + c.amount, 0);
            const incomePercentages = incomeCategories.map(c => ((c.amount / incomeTotalAmount) * 100).toFixed(0));
            
            new Chart(incomePieCtx, {
                type: 'doughnut',
                data: {
                    labels: incomeCategories.map(c => c.icon + ' ' + c.name),
                    datasets: [{
                        data: incomeCategories.map(c => c.amount),
                        backgroundColor: incomeCategories.map(c => c.color),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                },
                plugins: [{
                    id: 'incomeDatalabels',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((element, index) => {
                                const percentage = incomePercentages[index];
                                if (percentage > 4) {
                                    // Get the position for the label - even further from outer edge
                                    const model = element;
                                    const midAngle = (model.startAngle + model.endAngle) / 2;
                                    const labelRadius = model.innerRadius + (model.outerRadius - model.innerRadius) * 0.6;
                                    const x = model.x + Math.cos(midAngle) * labelRadius;
                                    const y = model.y + Math.sin(midAngle) * labelRadius;
                                    
                                    // Draw the percentage
                                    ctx.fillStyle = '#f3f4f6';
                                    ctx.font = 'bold 16px sans-serif';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText(percentage + '%', x, y);
                                }
                            });
                        });
                    }
                }]
            });
        }
        {% endif %}
        
        // Income Daily Chart
        const incomeCtx = document.getElementById('incomeChart').getContext('2d');
        new Chart(incomeCtx, {
            type: 'bar',
            data: {
                labels: dailyData.days,
                datasets: [{
                    label: '{{ income }}',
                    data: dailyIncomes,
                    backgroundColor: '#10b981',
                    borderWidth: 0,
                    barPercentage: 0.8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                return '{{ income }}: ' + value.toLocaleString('ru-RU') + ' ‚ÇΩ';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: {
                            maxRotation: 0,
                            callback: function(value, index) {
                                return (index + 1) % 5 === 0 ? index + 1 : '';
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
                            }
                        }
                    }
                }
            }
        });
        {% endif %}
    </script>
</body>
</html>
