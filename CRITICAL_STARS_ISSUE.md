# ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –í—ã–ø–ª–∞—Ç—ã Telegram Stars –ù–ï —Ä–∞–±–æ—Ç–∞—é—Ç!

## üö® –°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:
–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ **–ù–ï –≤—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ Telegram Stars**! –°–∏—Å—Ç–µ–º–∞ —Ç–æ–ª—å–∫–æ –∏–º–∏—Ç–∏—Ä—É–µ—Ç –≤—ã–ø–ª–∞—Ç—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ —Ä–µ–∞–ª—å–Ω—ã–µ Stars –Ω–µ –ø–µ—Ä–µ–≤–æ–¥—è—Ç—Å—è —Ä–µ—Ñ–µ—Ä–µ—Ä—É.

## –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
1. –†–µ—Ñ–µ—Ä–∞–ª –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ Stars
2. –°–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ–º–∏—Å—Å–∏—è 10% –¥–ª—è —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
3. –ß–µ—Ä–µ–∑ 21 –¥–µ–Ω—å –∫–æ–º–∏—Å—Å–∏—è "–≤—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è" (—Ç–æ–ª—å–∫–æ –≤ –ë–î)
4. –†–µ—Ñ–µ—Ä–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–ø–ª–∞—Ç–µ
5. **–ù–û Stars –ù–ï –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞ –±–∞–ª–∞–Ω—Å!**

## –ì–¥–µ –ø—Ä–æ–±–ª–µ–º–∞:
–§–∞–π–ª: `expenses/tasks.py`, —Ñ—É–Ω–∫—Ü–∏—è `_finalize_commission` (—Å—Ç—Ä–æ–∫–∏ 164-193)
```python
def _finalize_commission(commission: AffiliateCommission):
    # ...
    commission.status = 'paid'  # ‚Üê –¢–û–õ–¨–ö–û –ú–ï–ù–Ø–ï–¢ –°–¢–ê–¢–£–°
    commission.paid_at = now
    commission.save()
    # –ù–ï–¢ –≤—ã–∑–æ–≤–∞ Telegram API –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –≤—ã–ø–ª–∞—Ç—ã!
```

## –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å refundStarPayment (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```python
# –í _finalize_commission –¥–æ–±–∞–≤–∏—Ç—å:
try:
    # –ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç Stars —Ä–µ—Ñ–µ—Ä—Ä–µ—Ä—É
    result = await bot.refund_star_payment(
        user_id=commission.referrer.telegram_id,
        telegram_payment_charge_id=commission.telegram_payment_id,
        amount=commission.commission_amount
    )
    if result:
        commission.status = 'paid'
        commission.paid_at = now
        commission.save()
    else:
        commission.status = 'failed'
        commission.save()
        logger.error(f"Failed to refund stars for commission {commission.id}")
except Exception as e:
    logger.error(f"Error refunding stars: {e}")
    commission.status = 'failed'
    commission.save()
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –∏ –≤—ã–ø–ª–∞—á–∏–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é
- –ù–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –∫–æ–º–∏—Å—Å–∏–∏ –≤ –ë–î
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤—ã–ø–ª–∞—á–∏–≤–∞—Ç—å —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å
- –¢—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞

### –í–∞—Ä–∏–∞–Ω—Ç 3: –û—Ç–∫–ª—é—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É
–ï—Å–ª–∏ –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—ã–ø–ª–∞—Ç—ã, –ª—É—á—à–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É, —á–µ–º –æ–±–º–∞–Ω—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## ‚ö†Ô∏è –í–ê–ñ–ù–û:
1. **–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫:** –û–±–µ—â–∞–Ω–∏–µ –≤—ã–ø–ª–∞—Ç –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–µ—Ç–µ–Ω–∑–∏—è–º
2. **–†–µ–ø—É—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π —Ä–∏—Å–∫:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–π–º—É—Ç –æ–±–º–∞–Ω –∏ –ø–æ—Ç–µ—Ä—è—é—Ç –¥–æ–≤–µ—Ä–∏–µ
3. **Telegram Stars API:** –ò–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ refund (–≤–æ–∑–º–æ–∂–Ω–æ, —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–ª–∞—Ç–µ–∂–∞)

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≤—ã–ø–ª–∞—á–µ–Ω–Ω—ã–º–∏ –∫–æ–º–∏—Å—Å–∏—è–º–∏ –≤ –ë–î
2. –°–ø—Ä–æ—Å–∏—Ç—å, –ø–æ–ª—É—á–∏–ª –ª–∏ –æ–Ω Stars –Ω–∞ –±–∞–ª–∞–Ω—Å
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å Stars –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Telegram

## –°—Ä–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
1. **–û–°–¢–ê–ù–û–í–ò–¢–¨** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—ã–ø–ª–∞—Ç–∞—Ö –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
2. **–ü–†–û–í–ï–†–ò–¢–¨** –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å "–≤—ã–ø–ª–∞—á–µ–Ω–Ω—ã–º–∏" –∫–æ–º–∏—Å—Å–∏—è–º–∏
3. **–†–ï–®–ò–¢–¨** –∫–∞–∫ –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ —Ç–∞–∫–∏–µ –µ—Å—Ç—å
4. **–ò–ù–¢–ï–ì–†–ò–†–û–í–ê–¢–¨** —Ä–µ–∞–ª—å–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Telegram Stars:
- refundStarPayment –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—á–µ–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ –ø–ª–∞—Ç–µ–∂–∞
- –ù—É–∂–µ–Ω –±–∞–ª–∞–Ω—Å Stars —É –±–æ—Ç–∞ –¥–ª—è –≤—ã–ø–ª–∞—Ç
- API –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ª–∏–º–∏—Ç—ã –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:
**–°–†–û–ß–ù–û** –ª–∏–±–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã, –ª–∏–±–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –∏ —á–µ—Å—Ç–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å–∏—Ç—É–∞—Ü–∏—é.