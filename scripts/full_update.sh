#!/bin/bash

# –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤–∫–ª—é—á–∞—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –ª–µ–Ω–¥–∏–Ω–≥
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bash scripts/full_update.sh

# –°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
set -euo pipefail

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
trap 'echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–∫–µ $LINENO. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ!${NC}"; exit 1' ERR

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë         üöÄ –ü–û–õ–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï COINS BOT                   ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "docker-compose.yml" ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    echo -e "${RED}   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /home/batman/expense_bot${NC}"
    exit 1
fi

echo -e "${YELLOW}üìç –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)${NC}"
echo ""

# –®–∞–≥ 1: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo -e "${YELLOW}[1/10] üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...${NC}"
docker-compose down
echo -e "${GREEN}‚úì –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"
echo ""

# –®–∞–≥ 2: –û—á–∏—Å—Ç–∫–∞ Docker
echo -e "${YELLOW}[2/10] üßπ –û—á–∏—â–∞—é Docker —Å–∏—Å—Ç–µ–º—É...${NC}"
# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã expense_bot
echo -e "${YELLOW}  –£–¥–∞–ª—è—é —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã expense_bot...${NC}"
OLD_IMAGES=$(docker images -q 'expense_bot*' 2>/dev/null || true)
if [ -n "$OLD_IMAGES" ]; then
    docker rmi $OLD_IMAGES 2>/dev/null || true
    echo -e "${GREEN}  ‚úì –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã${NC}"
else
    echo -e "${YELLOW}  ‚Ñπ –°—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ${NC}"
fi
# –û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
docker system prune -af --volumes=false
echo -e "${GREEN}‚úì Docker –æ—á–∏—â–µ–Ω${NC}"
echo ""

# –®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git
echo -e "${YELLOW}[3/10] üì• –ü–æ–ª—É—á–∞—é –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git...${NC}"
git fetch --all
git reset --hard origin/master
git pull origin master
echo -e "${GREEN}‚úì –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è${NC}"
echo ""

# –®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ–Ω–¥–∏–Ω–≥–∞ –ü–ï–†–ï–î —Å–±–æ—Ä–∫–æ–π Docker
echo -e "${YELLOW}[4/10] üåê –û–±–Ω–æ–≤–ª—è—é –ª–µ–Ω–¥–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—É...${NC}"
# –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
chmod +x scripts/update_landing.sh
# –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ–Ω–¥–∏–Ω–≥–∞
bash scripts/update_landing.sh
echo -e "${GREEN}‚úì –õ–µ–Ω–¥–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω${NC}"
echo ""

# –®–∞–≥ 5: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
echo -e "${YELLOW}[5/10] üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é Docker –æ–±—Ä–∞–∑—ã...${NC}"
docker-compose build --no-cache
echo -e "${GREEN}‚úì Docker –æ–±—Ä–∞–∑—ã –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã${NC}"
echo ""

# –®–∞–≥ 6: –ó–∞–ø—É—Å–∫ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo -e "${YELLOW}[6/10] üöÄ –ó–∞–ø—É—Å–∫–∞—é –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...${NC}"
docker-compose up -d --force-recreate
echo -e "${GREEN}‚úì –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã${NC}"
echo ""

# –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo -e "${YELLOW}[7/10] üìä –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
docker-compose ps
echo ""

# –®–∞–≥ 8: –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo -e "${YELLOW}[8/10] ‚è≥ –ñ–¥—É –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
echo -e "${YELLOW}  –î–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...${NC}"
sleep 10
echo -e "${GREEN}‚úì –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≥–æ—Ç–æ–≤—ã${NC}"
echo ""

# –®–∞–≥ 9: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook
echo -e "${YELLOW}[9/10] üîó –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Telegram webhook...${NC}"

# –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x scripts/set_webhook.sh

# –ó–∞–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É webhook (–Ω–µ –ø–∞–¥–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ)
set +e
if bash scripts/set_webhook.sh; then
    echo -e "${GREEN}‚úì Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π webhook${NC}"
    echo -e "${YELLOW}  –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: bash ~/fix_webhook_force.sh${NC}"
fi
set -e
echo ""

# –®–∞–≥ 10: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
echo -e "${YELLOW}[10/10] üîç –í—ã–ø–æ–ª–Ω—è—é —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏...${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
RUNNING_CONTAINERS=$(docker-compose ps | grep "Up" | wc -l)
EXPECTED_CONTAINERS=5  # web, app, celery, celery_beat, redis

if [ $RUNNING_CONTAINERS -ge $EXPECTED_CONTAINERS ]; then
    echo -e "${GREEN}‚úì –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã ($RUNNING_CONTAINERS)${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è –ó–∞–ø—É—â–µ–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: $RUNNING_CONTAINERS –∏–∑ $EXPECTED_CONTAINERS –æ–∂–∏–¥–∞–µ–º—ã—Ö${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–æ–≤ (–Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
set +e
echo ""
echo -e "${YELLOW}üåê –ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∞–π—Ç–æ–≤...${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∫–∏
if curl -s -o /dev/null -w "%{http_code}" https://expensebot.duckdns.org/admin/ | grep -q "200\|301\|302"; then
    echo -e "${GREEN}‚úì –ê–¥–º–∏–Ω–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞: https://expensebot.duckdns.org/admin/${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è –ê–¥–º–∏–Ω–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–µ–Ω–¥–∏–Ω–≥–∞
if curl -s -o /dev/null -w "%{http_code}" https://www.coins-bot.ru | grep -q "200"; then
    echo -e "${GREEN}‚úì –õ–µ–Ω–¥–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–µ–Ω: https://www.coins-bot.ru${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è –õ–µ–Ω–¥–∏–Ω–≥ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
fi
set -e

echo ""
echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë         ‚úÖ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û!                 ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""
echo -e "${GREEN}üìå –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:${NC}"
echo -e "   1. –ë–æ—Ç –≤ Telegram: @showmecoinbot"
echo -e "   2. –ê–¥–º–∏–Ω–∫–∞: https://expensebot.duckdns.org/admin/"
echo -e "   3. –õ–µ–Ω–¥–∏–Ω–≥: https://www.coins-bot.ru"
echo ""
echo -e "${YELLOW}üí° –°–æ–≤–µ—Ç: –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:${NC}"
echo -e "   docker-compose logs -f app"
echo -e "   docker-compose logs -f web"
echo ""