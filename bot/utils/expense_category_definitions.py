"""
Shared definitions and helpers for expense categories.
–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤ (—Ä—É—Å—Å–∫–∏–µ + –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ).
"""
import re
from typing import Optional, Dict

# –í–ê–ñ–ù–û: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –º–æ–¥—É–ª—è (–≤–∫–ª—é—á–∞–µ—Ç ZWJ –¥–ª—è –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã—Ö —ç–º–æ–¥–∑–∏)
from bot.utils.emoji_utils import strip_leading_emoji


def _keyword_matches_in_text(keyword: str, text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –µ—Å—Ç—å –ª–∏ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –≤ —Ç–µ–∫—Å—Ç–µ –∫–∞–∫ –¶–ï–õ–û–ï –°–õ–û–í–û —Å —É—á–µ—Ç–æ–º —Å–∫–ª–æ–Ω–µ–Ω–∏–π.
    –õ–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–ø–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ expense_parser.py –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞.
    """
    if not keyword or not text:
        return False
    keyword_lower = keyword.lower().strip()
    text_lower = text.lower()
    text_words = re.findall(r'[\w–∞-—è—ë–ê-–Ø–Å\-]+', text_lower)
    for word in text_words:
        if word == keyword_lower:
            return True
        if word.startswith(keyword_lower):
            ending_length = len(word) - len(keyword_lower)
            if ending_length <= 2:
                return True
    return False


EXPENSE_CATEGORY_DEFINITIONS: Dict[str, Dict[str, object]] = {
    'groceries': {
        'name_ru': 'üõí –ü—Ä–æ–¥—É–∫—Ç—ã',
        'name_en': 'üõí Groceries',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ –º–∞–≥–∞–∑–∏–Ω—ã –∏ –±—Ä–µ–Ω–¥—ã
            '–º–∞–≥–Ω–∏—Ç', '–ø—è—Ç–µ—Ä–æ—á–∫–∞', '–ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫', '–∞—à–∞–Ω', '–ª–µ–Ω—Ç–∞', '–¥–∏–∫—Å–∏', '–≤–∫—É—Å–≤–∏–ª–ª',
            '–æ–∫–µ–π', '–∞–∑–±—É–∫–∞ –≤–∫—É—Å–∞', '–ø—Ä–æ–¥—É–∫—Ç—ã', '—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç', '–≥–∏–ø–µ—Ä–º–∞—Ä–∫–µ—Ç',
            '–æ–≤–æ—â–∏', '—Ñ—Ä—É–∫—Ç—ã', '–º—è—Å–æ', '—Ä—ã–±–∞', '–º–æ–ª–æ–∫–æ', '—Ö–ª–µ–±',
            '–ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π', '–±–∞–∫–∞–ª–µ—è', '—Å—ã—Ä', '–∫–æ–ª–±–∞—Å–∞', '–∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω—ã–π', '24 —á–∞—Å–∞',
            '–º–∞–∫–∞—Ä–æ–Ω—ã', '–∫—Ä—É–ø–∞', '—Ä–∏—Å', '–≥—Ä–µ—á–∫–∞', '—è–π—Ü–∞', '–º–∞—Å–ª–æ', '—Å–∞—Ö–∞—Ä', '—Å–æ–ª—å', '–º—É–∫–∞',
            '—Ö–∞–º—Å–∞', '–∫–∏–ª—å–∫–∞', '—Å–µ–ª–µ–¥–∫–∞', '—Å–µ–ª—å–¥—å', '—Å–∫—É–º–±—Ä–∏—è', '–º–∏–Ω—Ç–∞–π', '—Ç—Ä–µ—Å–∫–∞',
            '–∫–±', '–∫—Ä–∞—Å–Ω–æ–µ –±–µ–ª–æ–µ', '–≤–≤',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'groceries', 'supermarket', 'vegetables', 'fruits', 'meat', 'fish', 'milk',
            'bread', 'cheese', 'eggs', 'butter', 'food', 'store', 'walmart', 'target',
            'costco', 'whole foods', 'trader joes', 'grocery', 'market',
            # –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –±—Ä–µ–Ω–¥—ã
            'metro',
        ],
        'aliases': ['–ø—Ä–æ–¥—É–∫—Ç—ã', 'groceries', '–µ–¥–∞', 'food'],
    },
    'cafes_restaurants': {
        'name_ru': 'üçΩÔ∏è –ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã',
        'name_en': 'üçΩÔ∏è Cafes and Restaurants',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '—Ä–µ—Å—Ç–æ—Ä–∞–Ω', '–∫–∞—Ñ–µ', '–±–∞—Ä', '–ø–∞–±', '–∫–æ—Ñ–µ–π–Ω—è', '–ø–∏—Ü—Ü–µ—Ä–∏—è', '—Å—É—à–∏', '—Ñ–∞—Å—Ç—Ñ—É–¥',
            '—Å—Ç–æ–ª–æ–≤–∞—è', '–±—É—Ñ–µ—Ç', '–±–∏—Å—Ç—Ä–æ', '–∫—É–ª–∏–Ω–∞—Ä–∏—è', '–∫–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–∞—è',
            '–æ–±–µ–¥', '—É–∂–∏–Ω', '–∑–∞–≤—Ç—Ä–∞–∫', '–ª–∞–Ω—á', '–¥–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã', 'delivery club', '—è–Ω–¥–µ–∫—Å –µ–¥–∞',
            '—à–æ–∫–æ–ª–∞–¥–Ω–∏—Ü–∞', '—Ç–µ—Ä–µ–º–æ–∫', '–∫—Ä–æ—à–∫–∞ –∫–∞—Ä—Ç–æ—à–∫–∞', '–¥–æ–¥–æ –ø–∏—Ü—Ü–∞', '–ø–∞–ø–∞ –¥–∂–æ–Ω—Å',
            '–∫–æ—Ñ–µ', '–∫–∞–ø—É—á–∏–Ω–æ', '–ª–∞—Ç—Ç–µ', '–∞–º–µ—Ä–∏–∫–∞–Ω–æ', '—ç—Å–ø—Ä–µ—Å—Å–æ', '—á–∞–π', '–ø–∏—Ü—Ü–∞',
            '–±—É—Ä–≥–µ—Ä', '—Ä–æ–ª–ª—ã', '–ø–∞—Å—Ç–∞', '—Å–∞–ª–∞—Ç', '–¥–µ—Å–µ—Ä—Ç', '–º–æ—Ä–æ–∂–µ–Ω–æ–µ', '—Ç–æ—Ä—Ç',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'restaurant', 'cafe', 'bar', 'pub', 'diner', 'bistro', 'pizza', 'sushi',
            'fastfood', 'fast food', 'lunch', 'dinner', 'breakfast', 'brunch', 'meal',
            'burger', 'sandwich', 'pasta', 'salad', 'soup', 'dessert', 'ice cream',
            'cappuccino', 'latte', 'espresso', 'americano', 'tea', 'coffee',
            # –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –±—Ä–µ–Ω–¥—ã
            'mcdonalds', 'kfc', 'burger king', 'subway', 'starbucks',
        ],
        'aliases': ['–∫–∞—Ñ–µ', 'cafes', '—Ä–µ—Å—Ç–æ—Ä–∞–Ω', 'restaurant', '–µ–¥–∞ –≤–Ω–µ –¥–æ–º–∞'],
    },
    'gas_station': {
        'name_ru': '‚õΩ –ê–ó–°',
        'name_en': '‚õΩ Gas Station',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '–∞–∑—Å', '–∑–∞–ø—Ä–∞–≤–∫–∞', '–±–µ–Ω–∑–∏–Ω', '—Ç–æ–ø–ª–∏–≤–æ', '–≥–∞–∑–ø—Ä–æ–º', '–ª—É–∫–æ–π–ª', '—Ä–æ—Å–Ω–µ—Ñ—Ç—å',
            '—Ç–∞—Ç–Ω–µ—Ñ—Ç—å', '–≥–∞–∑–ø—Ä–æ–º–Ω–µ—Ñ—Ç—å', '–¥–∏–∑–µ–ª—å', '–≥–∞–∑', '–≥—Å–º',
            '92', '95', '98', '–∞–∏-92', '–∞–∏-95', '–∞–∏-98', '–¥—Ç', '–∞–≤—Ç–æ–∑–∞–ø—Ä–∞–≤–∫–∞',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'gas', 'gasoline', 'petrol', 'fuel', 'diesel', 'gas station', 'station',
            'chevron', 'exxon', 'mobil', 'texaco', 'citgo', '7-eleven', 'fill up',
            # –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –±—Ä–µ–Ω–¥—ã
            'shell', 'bp', 'esso',
        ],
        'aliases': ['–∞–∑—Å', 'gas station', '–∑–∞–ø—Ä–∞–≤–∫–∞', '–±–µ–Ω–∑–∏–Ω', 'gasoline'],
    },
    'transport': {
        'name_ru': 'üöï –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
        'name_en': 'üöï Transport',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '—Ç–∞–∫—Å–∏', 'uber', '—è–Ω–¥–µ–∫—Å —Ç–∞–∫—Å–∏', '—Å–∏—Ç–∏–º–æ–±–∏–ª', 'gett', 'wheely', '–º–µ—Ç—Ä–æ',
            '–∞–≤—Ç–æ–±—É—Å', '—Ç—Ä–æ–ª–ª–µ–π–±—É—Å', '—Ç—Ä–∞–º–≤–∞–π', '–º–∞—Ä—à—Ä—É—Ç–∫–∞', '—ç–ª–µ–∫—Ç—Ä–∏—á–∫–∞', '–ø—Ä–æ–µ–∑–¥',
            '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç', '—Ç—Ä–æ–π–∫–∞', '–µ–¥–∏–Ω—ã–π', '–±–∏–ª–µ—Ç', '–ø–æ–¥–æ—Ä–æ–∂–Ω–∏–∫', '–ø—Ä–æ–µ–∑–¥–Ω–æ–π',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'taxi', 'bus', 'metro', 'subway', 'train', 'tram', 'trolleybus', 'transport',
            'ride', 'lyft', 'bolt', 'ticket', 'travel card',
        ],
        'aliases': ['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç', 'transport', '—Ç–∞–∫—Å–∏', 'taxi'],
    },
    'car': {
        'name_ru': 'üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å',
        'name_en': 'üöó Car',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '–∞–≤—Ç–æ–º–æ–±–∏–ª—å', '–º–∞—à–∏–Ω–∞', '–∞–≤—Ç–æ', '—Å—Ç–æ', '–∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å', '—à–∏–Ω–æ–º–æ–Ω—Ç–∞–∂', '–º–æ–π–∫–∞',
            '–ø–∞—Ä–∫–æ–≤–∫–∞', '—à—Ç—Ä–∞—Ñ', '–≥–∏–±–¥–¥', '–æ—Å–∞–≥–æ', '–∫–∞—Å–∫–æ', '—Ç–µ—Ö–æ—Å–º–æ—Ç—Ä',
            '–∑–∞–ø—á–∞—Å—Ç–∏', '–º–∞—Å–ª–æ', '–∞–Ω—Ç–∏—Ñ—Ä–∏–∑', '—Å—Ç–µ–∫–ª–æ–æ–º—ã–≤–∞—Ç–µ–ª—å', '–∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–∏',
            '—Ä–µ–º–æ–Ω—Ç –∞–≤—Ç–æ', '—Ä–µ–º–æ–Ω—Ç –º–∞—à–∏–Ω—ã', '—Ä–µ–º–æ–Ω—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª—è',
            '–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Ä–æ–≥–∞', '–ø–ª–∞—Ç–Ω–∞—è —Ç—Ä–∞—Å—Å–∞', 'toll', '–º4', '–∑—Å–¥', '—Ü–∫–∞–¥',
            # –ê–ó–° –∏ —Ç–æ–ø–ª–∏–≤–æ (–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ê–ó–°)
            '–∞–∑—Å', '–∑–∞–ø—Ä–∞–≤–∫–∞', '–±–µ–Ω–∑–∏–Ω', '—Ç–æ–ø–ª–∏–≤–æ', '–≥–∞–∑–ø—Ä–æ–º', '–ª—É–∫–æ–π–ª', '—Ä–æ—Å–Ω–µ—Ñ—Ç—å',
            '—Ç–∞—Ç–Ω–µ—Ñ—Ç—å', '–≥–∞–∑–ø—Ä–æ–º–Ω–µ—Ñ—Ç—å', '–¥–∏–∑–µ–ª—å', '–≥–∞–∑', '–≥—Å–º',
            '92', '95', '98', '–∞–∏-92', '–∞–∏-95', '–∞–∏-98', '–¥—Ç', '–∞–≤—Ç–æ–∑–∞–ø—Ä–∞–≤–∫–∞',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'car', 'vehicle', 'auto', 'repair', 'service', 'maintenance', 'parts',
            'oil', 'tire', 'tires', 'wash', 'parking', 'fine', 'ticket', 'insurance',
            'inspection', 'antifreeze', 'coolant', 'road toll',
            # –ê–ó–° –∏ —Ç–æ–ø–ª–∏–≤–æ (–∞–Ω–≥–ª–∏–π—Å–∫–∏–µ)
            'gas', 'gasoline', 'petrol', 'fuel', 'diesel', 'gas station', 'station',
            'chevron', 'exxon', 'mobil', 'texaco', 'citgo', '7-eleven', 'fill up',
            # –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –±—Ä–µ–Ω–¥—ã –ê–ó–°
            'shell', 'bp', 'esso',
        ],
        'aliases': ['–∞–≤—Ç–æ–º–æ–±–∏–ª—å', 'car', '–º–∞—à–∏–Ω–∞', '–∞–≤—Ç–æ', '–∞–∑—Å', '–∑–∞–ø—Ä–∞–≤–∫–∞'],
    },
    'housing': {
        'name_ru': 'üè† –ñ–∏–ª—å–µ',
        'name_en': 'üè† Housing',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '–∫–≤–∞—Ä—Ç–∏—Ä–∞', '–∞—Ä–µ–Ω–¥–∞', '–∏–ø–æ—Ç–µ–∫–∞', '–∫–≤–∞—Ä—Ç–ø–ª–∞—Ç–∞',
            '—É–ø—Ä–∞–≤–ª—è—é—â–∞—è –∫–æ–º–ø–∞–Ω–∏—è', '—Ç—Å–∂', '–∂—Å–∫', '–∫–∞–ø—Ä–µ–º–æ–Ω—Ç', '–¥–æ–º–æ—Ñ–æ–Ω', '–∫–æ–Ω—Å—å–µ—Ä–∂',
            '–æ—Ö—Ä–∞–Ω–∞', '—É–±–æ—Ä–∫–∞', '—Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫', '—ç–ª–µ–∫—Ç—Ä–∏–∫',
            # –ë—ã—Ç–æ–≤–∞—è —Ö–∏–º–∏—è –∏ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –¥–æ–º–∞
            '–ø–æ—Å—É–¥–æ–º–æ–µ—á–Ω—ã–µ', '—Å—Ç–∏—Ä–∞–ª—å–Ω—ã–π', '—Å—Ç–∏—Ä–∞–ª—å–Ω—ã–µ', '–ø–æ—Ä–æ—à–æ–∫', '–º–æ—é—â–µ–µ', '—á–∏—Å—Ç—è—â–µ–µ',
            '—Å—Ä–µ–¥—Å—Ç–≤–æ –¥–ª—è', 'fairy', 'finish', 'calgon', 'vanish', 'domestos',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'apartment', 'rent', 'rental', 'mortgage', 'housing', 'home',
            'plumber', 'electrician', 'repair', 'cleaning', 'security', 'maintenance',
            'dishwasher tablets', 'laundry', 'detergent', 'cleaning supplies',
        ],
        'aliases': ['–∂–∏–ª—å–µ', 'housing', '–∫–≤–∞—Ä—Ç–∏—Ä–∞', 'apartment'],
    },
    'pharmacies': {
        'name_ru': 'üíä –ê–ø—Ç–µ–∫–∏',
        'name_en': 'üíä Pharmacies',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '–∞–ø—Ç–µ–∫–∞', '—Ä–∏–≥–ª–∞', '–∞—Å–Ω–∞', '36.6', '–≥–æ—Ä–∑–¥—Ä–∞–≤', '—Å—Ç–æ–ª–∏—á–∫–∏', '—Ñ–∞—Ä–º–∞—Ü–∏—è',
            '–ª–µ–∫–∞—Ä—Å—Ç–≤–∞', '–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã', '—Ç–∞–±–ª–µ—Ç–∫–∏', '–≤–∏—Ç–∞–º–∏–Ω—ã', '–±–∞–¥',
            '–∞–ø—Ç–µ—á–Ω—ã–π', '—Ä–µ—Ü–µ–ø—Ç', '–ø—Ä–µ–ø–∞—Ä–∞—Ç', '–ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π', '–∑–¥—Ä–∞–≤—Å–∏—Ç–∏',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'pharmacy', 'drugstore', 'medicine', 'pills', 'vitamins', 'supplements',
            'prescription', 'medication', 'drugs', 'cvs', 'walgreens', 'rite aid',
        ],
        'aliases': ['–∞–ø—Ç–µ–∫–∞', 'pharmacy', '–ª–µ–∫–∞—Ä—Å—Ç–≤–∞', 'medicine'],
    },
    'medicine': {
        'name_ru': 'üè• –ú–µ–¥–∏—Ü–∏–Ω–∞',
        'name_en': 'üè• Medicine',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '–∫–ª–∏–Ω–∏–∫–∞', '–±–æ–ª—å–Ω–∏—Ü–∞', '–ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞', '–≤—Ä–∞—á', '–¥–æ–∫—Ç–æ—Ä', '–º–µ–¥—Ü–µ–Ω—Ç—Ä',
            '—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è', '–∑—É–±–Ω–æ–π', '–∞–Ω–∞–ª–∏–∑—ã', '—É–∑–∏', '–º—Ä—Ç', '–∫—Ç', '—Ä–µ–Ω—Ç–≥–µ–Ω',
            '–æ—Å–º–æ—Ç—Ä', '–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è', '–ª–µ—á–µ–Ω–∏–µ', '–æ–ø–µ—Ä–∞—Ü–∏—è', '–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π', '—Ç–µ—Ä–∞–ø–µ–≤—Ç',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'clinic', 'hospital', 'doctor', 'dentist', 'medical', 'health', 'checkup',
            'xray', 'mri', 'ct', 'scan', 'test', 'exam', 'consultation', 'surgery',
        ],
        'aliases': ['–º–µ–¥–∏—Ü–∏–Ω–∞', 'medicine', '–≤—Ä–∞—á', 'doctor', '–∫–ª–∏–Ω–∏–∫–∞', 'clinic'],
    },
    'beauty': {
        'name_ru': 'üíÑ –ö—Ä–∞—Å–æ—Ç–∞',
        'name_en': 'üíÑ Beauty',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '—Å–∞–ª–æ–Ω', '–ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä—Å–∫–∞—è', '–±–∞—Ä–±–µ—Ä—à–æ–ø', '–º–∞–Ω–∏–∫—é—Ä', '–ø–µ–¥–∏–∫—é—Ä', '–∫–æ—Å–º–µ—Ç–æ–ª–æ–≥',
            '—Å–ø–∞', 'spa', '–º–∞—Å—Å–∞–∂', '—Å–æ–ª—è—Ä–∏–π', '—ç–ø–∏–ª—è—Ü–∏—è', '–¥–µ–ø–∏–ª—è—Ü–∏—è', '—Å—Ç—Ä–∏–∂–∫–∞',
            '–æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ', '—É–∫–ª–∞–¥–∫–∞', '–∫–æ—Å–º–µ—Ç–∏–∫–∞', 'beauty', '–∫—Ä–∞—Å–æ—Ç–∞', '—É—Ö–æ–¥',
            '–ø–∞—Ä—Ñ—é–º', '–¥—É—Ö–∏', '—Ç—É–∞–ª–µ—Ç–Ω–∞—è –≤–æ–¥–∞', '–ø–∞—Ä—Ñ—é–º–µ—Ä–∏—è', '–∞—Ä–æ–º–∞—Ç',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'salon', 'hairdresser', 'barber', 'haircut', 'manicure', 'pedicure',
            'massage', 'cosmetics', 'makeup', 'grooming', 'styling', 'nails',
            'perfume', 'fragrance', 'cologne', 'eau de toilette',
        ],
        'aliases': ['–∫—Ä–∞—Å–æ—Ç–∞', 'beauty', '—Å–∞–ª–æ–Ω', 'salon'],
    },
    'sports_fitness': {
        'name_ru': 'üèÉ –°–ø–æ—Ä—Ç –∏ —Ñ–∏—Ç–Ω–µ—Å',
        'name_en': 'üèÉ Sports and Fitness',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '—Ñ–∏—Ç–Ω–µ—Å', '—Å–ø–æ—Ä—Ç–∑–∞–ª', '—Ç—Ä–µ–Ω–∞–∂–µ—Ä–Ω—ã–π', '–±–∞—Å—Å–µ–π–Ω', '–π–æ–≥–∞', '–ø–∏–ª–∞—Ç–µ—Å', '—Ç–∞–Ω—Ü—ã',
            '—Å–ø–æ—Ä—Ç', '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', '–∞–±–æ–Ω–µ–º–µ–Ω—Ç', 'world class', 'fitness', 'x-fit',
            '—Å–ø–æ—Ä—Ç–º–∞—Å—Ç–µ—Ä', '–¥–µ–∫–∞—Ç–ª–æ–Ω', '—Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π', '—Ç—Ä–µ–Ω–µ—Ä', '—Å–µ–∫—Ü–∏—è', '—Ñ–∏—Ç–Ω–µ—Å –∫–ª—É–±',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'gym', 'workout', 'training', 'sport', 'swimming', 'pool',
            'yoga', 'pilates', 'dance', 'membership', 'trainer', 'exercise',
        ],
        'aliases': ['—Å–ø–æ—Ä—Ç', 'sports', '—Ñ–∏—Ç–Ω–µ—Å', 'fitness', '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', 'workout'],
    },
    'clothes_shoes': {
        'name_ru': 'üëî –û–¥–µ–∂–¥–∞ –∏ –æ–±—É–≤—å',
        'name_en': 'üëî Clothes and Shoes',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '–æ–¥–µ–∂–¥–∞', '–æ–±—É–≤—å', '–º–∞–≥–∞–∑–∏–Ω –æ–¥–µ–∂–¥—ã',
            '–±—É—Ç–∏–∫', '–¥–∂–∏–Ω—Å—ã', '–ø–ª–∞—Ç—å–µ', '–∫–æ—Å—Ç—é–º', '–∫—Ä–æ—Å—Å–æ–≤–∫–∏', '—Ç—É—Ñ–ª–∏', '—Å–∞–ø–æ–≥–∏',
            '–∫—É—Ä—Ç–∫–∞', '–ø–∞–ª—å—Ç–æ', '—Ä—É–±–∞—à–∫–∞', '—é–±–∫–∞', '–±—Ä—é–∫–∏', '–±–µ–ª—å–µ', '–Ω–æ—Å–∫–∏',
            '–º–∞—Å—Ç–µ—Ä–∫–∞', '–∫–æ—Ñ—Ç–∞', '—Å–≤–∏—Ç–µ—Ä', '—Ç–æ–ª—Å—Ç–æ–≤–∫–∞', '—Ö—É–¥–∏',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'clothes', 'clothing', 'shoes', 'dress', 'jeans', 'shirt', 'pants',
            'jacket', 'coat', 'suit', 'sneakers', 'boots', 'fashion', 'apparel',
            # –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –±—Ä–µ–Ω–¥—ã
            'zara', 'h&m', 'uniqlo', 'mango', 'bershka',
        ],
        'aliases': ['–æ–¥–µ–∂–¥–∞', 'clothes', '–æ–±—É–≤—å', 'shoes'],
    },
    'entertainment': {
        'name_ru': 'üé≠ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è',
        'name_en': 'üé≠ Entertainment',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '–∫–∏–Ω–æ', '—Ç–µ–∞—Ç—Ä', '–∫–æ–Ω—Ü–µ—Ä—Ç', '–º—É–∑–µ–π', '–≤—ã—Å—Ç–∞–≤–∫–∞', '–∫–ª—É–±', '–∫–∞—Ä–∞–æ–∫–µ', '–±–æ—É–ª–∏–Ω–≥',
            '–±–∏–ª—å—è—Ä–¥', '–∫–≤–µ—Å—Ç', '—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', '–æ—Ç–¥—ã—Ö', '–¥–æ—Å—É–≥', '–ø–∞—Ä–∫', '–∞—Ç—Ç—Ä–∞–∫—Ü–∏–æ–Ω—ã',
            '—Ü–∏—Ä–∫', '–∑–æ–æ–ø–∞—Ä–∫', '–∞–∫–≤–∞–ø–∞—Ä–∫', '–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä', '—Å–∏–Ω–µ–º–∞', 'imax', '–±–∏–ª–µ—Ç',
            '–ø–∏–≤–æ', '–≤–∏–Ω–æ', '–∞–ª–∫–æ–≥–æ–ª—å', '–∫–æ–∫—Ç–µ–π–ª—å', '–≤–∏—Å–∫–∏', '–≤–æ–¥–∫–∞', '–∫–æ–Ω—å—è–∫', '—à–∞–º–ø–∞–Ω—Å–∫–æ–µ',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'cinema', 'movie', 'theater', 'theatre', 'concert', 'museum', 'exhibition',
            'club', 'karaoke', 'bowling', 'billiards', 'entertainment', 'fun', 'leisure',
            'park', 'zoo', 'circus', 'amusement', 'beer', 'wine', 'alcohol', 'cocktail',
        ],
        'aliases': ['—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', 'entertainment', '–∫–∏–Ω–æ', 'cinema'],
    },
    'education': {
        'name_ru': 'üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',
        'name_en': 'üìö Education',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '–∫—É—Ä—Å—ã', '–æ–±—É—á–µ–Ω–∏–µ', '—à–∫–æ–ª–∞', '—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç', '–∏–Ω—Å—Ç–∏—Ç—É—Ç', '–∫–æ–ª–ª–µ–¥–∂', '—É—á–µ–±–∞',
            '–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', '—Ç—Ä–µ–Ω–∏–Ω–≥', '—Å–µ–º–∏–Ω–∞—Ä', '–≤–µ–±–∏–Ω–∞—Ä', '—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä', '—É—á–µ–±–Ω–∏–∫',
            '–∫–Ω–∏–≥–∏', '–∫–∞–Ω—Ü–µ–ª—è—Ä–∏—è', '—Ç–µ—Ç—Ä–∞–¥–∏', '—Ä—É—á–∫–∏', '—É—á–µ–±–Ω—ã–π', '—ç–∫–∑–∞–º–µ–Ω', '–¥–∏–ø–ª–æ–º',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'education', 'course', 'courses', 'school', 'university', 'college',
            'training', 'seminar', 'webinar', 'tutor', 'books', 'textbook', 'study',
            'learning', 'exam', 'diploma', 'certificate',
        ],
        'aliases': ['–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', 'education', '–æ–±—É—á–µ–Ω–∏–µ', 'learning'],
    },
    'gifts': {
        'name_ru': 'üéÅ –ü–æ–¥–∞—Ä–∫–∏',
        'name_en': 'üéÅ Gifts',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '–ø–æ–¥–∞—Ä–æ–∫', '—Å—É–≤–µ–Ω–∏—Ä', '—Ü–≤–µ—Ç—ã', '–±—É–∫–µ—Ç', '–æ—Ç–∫—Ä—ã—Ç–∫–∞', '–ø–æ–¥–∞—Ä–æ—á–Ω—ã–π', '–ø—Ä–µ–∑–µ–Ω—Ç',
            '–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ', '–ø—Ä–∞–∑–¥–Ω–∏–∫', '–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è', '—é–±–∏–ª–µ–π', '—Å–≤–∞–¥—å–±–∞',
            '—Ñ–ª–æ—Ä–∏—Å—Ç', '—Ü–≤–µ—Ç–æ—á–Ω—ã–π', '—É–ø–∞–∫–æ–≤–∫–∞', '–ª–µ–Ω—Ç–∞', '—à–∞—Ä—ã', '–¥–µ–∫–æ—Ä',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'gift', 'present', 'souvenir', 'flowers', 'bouquet', 'card', 'birthday',
            'anniversary', 'wedding', 'celebration', 'party', 'balloons',
        ],
        'aliases': ['–ø–æ–¥–∞—Ä–∫–∏', 'gifts', '–ø–æ–¥–∞—Ä–æ–∫', 'gift'],
    },
    'travel': {
        'name_ru': '‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è',
        'name_en': '‚úàÔ∏è Travel',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '–∞–≤–∏–∞–±–∏–ª–µ—Ç', '–±–∏–ª–µ—Ç', '—Å–∞–º–æ–ª–µ—Ç', '–ø–æ–µ–∑–¥', '—Ä–∂–¥', '–∞—ç—Ä–æ—Ñ–ª–æ—Ç', '–ø–æ–±–µ–¥–∞',
            's7', 'utair', '–æ—Ç–µ–ª—å', '–≥–æ—Å—Ç–∏–Ω–∏—Ü–∞', '—Ö–æ—Å—Ç–µ–ª',
            '–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ', '–æ—Ç–ø—É—Å–∫', '—Ç—É—Ä–∏–∑–º', '—ç–∫—Å–∫—É—Ä—Å–∏—è', '–≥–∏–¥', '–≤–∏–∑–∞', '–ø–∞—Å–ø–æ—Ä—Ç',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'travel', 'trip', 'vacation', 'flight', 'plane', 'airport', 'hotel',
            'hostel', 'accommodation', 'tour', 'excursion', 'guide', 'visa', 'passport',
            # –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –±—Ä–µ–Ω–¥—ã
            'booking', 'airbnb',
        ],
        'aliases': ['–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', 'travel', '–æ—Ç–ø—É—Å–∫', 'vacation'],
    },
    'utilities_subscriptions': {
        'name_ru': 'üì± –ö–æ–º–º—É–Ω–∞–ª–∫–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏',
        'name_en': 'üì± Utilities and Subscriptions',
        'keywords': [
            # –ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
            '–∂–∫—Ö', '–∫–æ–º–º—É–Ω–∞–ª–∫–∞', '–∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ', '–∫–≤–∏—Ç–∞–Ω—Ü–∏—è', '—Å—á–µ—Ç –∑–∞',
            '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç', '–º–æ–±–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å', '—Ç–µ–ª–µ—Ñ–æ–Ω', '–º—Ç—Å', '–±–∏–ª–∞–π–Ω', '–º–µ–≥–∞—Ñ–æ–Ω', '—Ç–µ–ª–µ2',
            '—Ä–æ—Å—Ç–µ–ª–µ–∫–æ–º', '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ', '–≥–∞–∑', '–≤–æ–¥–∞', '–æ—Ç–æ–ø–ª–µ–Ω–∏–µ', '—Å–≤–µ—Ç',
            # –ü–æ–¥–ø–∏—Å–∫–∏
            '–ø–æ–¥–ø–∏—Å–∫–∞', '—è–Ω–¥–µ–∫—Å –ø–ª—é—Å', '–∫–∏–Ω–æ–ø–æ–∏—Å–∫', '–∏–≤–∏', '–æ–∫–∫–æ', '–∞–º–µ–¥–∏–∞—Ç–µ–∫–∞',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'utilities', 'bills', 'utility bill',
            'internet', 'mobile', 'phone', 'cellular', 'electricity', 'water', 'heating',
            'subscription', 'streaming', 'apple music', 'amazon prime', 'disney plus', 'hbo', 'hulu',
            # –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –±—Ä–µ–Ω–¥—ã
            'netflix', 'spotify', 'youtube', 'apple', 'google', 'xbox', 'playstation', 'steam',
        ],
        'aliases': ['–∫–æ–º–º—É–Ω–∞–ª–∫–∞', 'utilities', '–ø–æ–¥–ø–∏—Å–∫–∏', 'subscriptions', '–∂–∫—Ö'],
    },
    'savings': {
        'name_ru': 'üíé –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è',
        'name_en': 'üíé Savings',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è', '–±—Ä–æ–∫–µ—Ä', '–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–ª', '–≤–∫–ª–∞–¥', '–∫—É–±—ã—à–∫–∞', '–Ω–∞ –ø–µ–Ω—Å–∏—é',
            '—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è', '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', '–¥–µ–ø–æ–∑–∏—Ç', '–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π', '–ø–µ–Ω—Å–∏–æ–Ω–Ω—ã–π',
            '–æ—Ç–∫–ª–∞–¥—ã–≤–∞—é', '–æ—Ç–ª–æ–∂–∏–ª', '–∫–æ–ø–∏—Ç—å', '—Å–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–π', '–∫–æ–ø–∏–ª–∫–∞',
            '–∏–Ω–≤–µ—Å—Ç–∏—Ä—É—é', '–≤–ª–æ–∂–∏–ª', '–≤–∫–ª–∞–¥—ã–≤–∞—é', '–ø–æ—Ä—Ç—Ñ–µ–ª—å',
            '–∞–∫—Ü–∏–∏', '–æ–±–ª–∏–≥–∞—Ü–∏–∏', '—Ñ–æ–Ω–¥', '–µ—Ç—Ñ', 'etf', '–ø–∏—Ñ', '–∏–∏—Å',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'savings', 'save', 'saving', 'nest egg', 'rainy day fund', 'emergency fund',
            'investment', 'invested', 'investing', 'portfolio', 'broker', 'brokerage',
            'stocks', 'bonds', 'fund', 'mutual fund', 'index fund',
            'deposit', 'bank deposit', 'term deposit', 'saving account',
            'pension', 'retirement', 'ira', '401k',
        ],
        'aliases': ['–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è', 'savings', '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', 'investments'],
    },
    'other': {
        'name_ru': 'üí∞ –ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã',
        'name_en': 'üí∞ Other Expenses',
        'keywords': [
            # –†—É—Å—Å–∫–∏–µ
            '–ø—Ä–æ—á–µ–µ', '—Ä–∞–∑–Ω–æ–µ', '–¥—Ä—É–≥–æ–µ', '–∏–Ω–æ–µ', '–ø—Ä–æ—á–∏–µ', '—Ä–∞—Å—Ö–æ–¥',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ
            'other', 'misc', 'miscellaneous', 'various', 'different', 'expense',
        ],
        'aliases': ['–ø—Ä–æ—á–∏–µ', 'other', '—Ä–∞–∑–Ω–æ–µ', 'misc'],
    },
}

DEFAULT_EXPENSE_CATEGORY_KEY = 'other'


def get_expense_category_display_name(category_key: str, language_code: str = 'ru') -> str:
    """Return the localized category name (with emoji) for the given key."""
    data = EXPENSE_CATEGORY_DEFINITIONS.get(category_key) or EXPENSE_CATEGORY_DEFINITIONS[DEFAULT_EXPENSE_CATEGORY_KEY]
    if language_code.lower().startswith('en'):
        return data['name_en']  # type: ignore[index]
    return data['name_ru']  # type: ignore[index]


def normalize_expense_category_key(label: Optional[str]) -> Optional[str]:
    """Map a raw category label to a canonical category key."""
    if not label:
        return None
    cleaned = strip_leading_emoji(label).lower()
    if not cleaned:
        return None

    for key, data in EXPENSE_CATEGORY_DEFINITIONS.items():
        potential_matches = {
            strip_leading_emoji(data['name_ru']).lower(),
            strip_leading_emoji(data['name_en']).lower(),
        }

        if cleaned in potential_matches:
            return key

        for alias in data.get('aliases', []):
            alias_lower = alias.lower()
            if alias_lower and (alias_lower == cleaned or alias_lower in cleaned or cleaned in alias_lower):
                return key

        for keyword in data.get('keywords', []):
            keyword_lower = keyword.lower()
            if keyword_lower and (keyword_lower == cleaned or keyword_lower in cleaned or cleaned in keyword_lower):
                return key

    return None


def detect_expense_category_key(text: str) -> Optional[str]:
    """Detect a category key by checking keywords against the text."""
    # Track best match with score
    best_key = None
    best_score = 0

    for key, data in EXPENSE_CATEGORY_DEFINITIONS.items():
        if key == DEFAULT_EXPENSE_CATEGORY_KEY:
            continue

        score = 0
        for keyword in data.get('keywords', []):
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ü–µ–ª–æ–≥–æ —Å–ª–æ–≤–∞ –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ `in`
            # —á—Ç–æ–±—ã "95" –Ω–µ —Å–æ–≤–ø–∞–¥–∞–ª–æ —Å "9500" –∏ —Ç.–ø.
            if _keyword_matches_in_text(keyword, text):
                score += 1

        if score > best_score:
            best_score = score
            best_key = key

    return best_key
