import logging
from datetime import datetime, date, timedelta
from typing import List, Dict, Any, Optional
from decimal import Decimal

from aiogram import Bot
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

from profiles.models import Profile
from expenses.models import Expense, Budget
from ..services.expense import get_today_summary, get_month_summary
from ..services.reports import generate_monthly_report

logger = logging.getLogger(__name__)


class NotificationService:
    def __init__(self, bot: Bot):
        self.bot = bot
        
    async def send_daily_report(self, user_id: int, profile: Profile):
        """Send daily expense report"""
        try:
            today = date.today()
            summary = await get_today_summary(user_id)
            
            if not summary or summary['total'] == 0:
                # No expenses today, skip notification
                return
            
            # Format daily report
            text = f"""üìä –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –∑–∞ {today.strftime('%d.%m.%Y')}

üí∞ –ü–æ—Ç—Ä–∞—á–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è: {summary['total']:,.0f} ‚ÇΩ
üìù –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞—Ç: {summary['count']}

üìä –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:"""
            
            # Add top categories
            for cat in summary['categories'][:5]:
                percent = (cat['amount'] / summary['total']) * 100
                text += f"\n{cat['icon']} {cat['name']}: {cat['amount']:,.0f} ‚ÇΩ ({percent:.1f}%)"
            
            # Check budgets
            budget_warnings = await self._check_budgets(profile, summary['total'])
            if budget_warnings:
                text += "\n\n‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø–æ –±—é–¥–∂–µ—Ç–∞–º:"
                for warning in budget_warnings:
                    text += f"\n‚Ä¢ {warning}"
            
            # Add buttons
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üìÖ –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞ –º–µ—Å—è—Ü", callback_data="expenses_month")],
                [InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥", callback_data="add_expense")]
            ])
            
            await self.bot.send_message(
                chat_id=user_id,
                text=text,
                reply_markup=keyboard
            )
            
            logger.info(f"Daily report sent to user {user_id}")
            
        except Exception as e:
            logger.error(f"Error sending daily report to user {user_id}: {e}")
    
    async def send_weekly_report(self, user_id: int, profile: Profile):
        """Send weekly expense report"""
        try:
            today = date.today()
            week_start = today - timedelta(days=today.weekday())
            
            # Get weekly expenses
            expenses = await Expense.objects.filter(
                profile=profile,
                date__gte=week_start,
                date__lte=today
            ).select_related('category').aall()
            
            if not expenses:
                return
            
            total = sum(e.amount for e in expenses)
            
            # Group by category
            categories = {}
            for expense in expenses:
                # –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —ç–º–æ–¥–∑–∏
                cat_name = expense.category.name if expense.category else "üí∞ –ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã"
                categories[cat_name] = categories.get(cat_name, 0) + expense.amount
            
            # Sort categories by amount
            sorted_cats = sorted(categories.items(), key=lambda x: x[1], reverse=True)
            
            # Format weekly report
            text = f"""üìä –ù–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç ({week_start.strftime('%d.%m')} - {today.strftime('%d.%m')})

üí∞ –ü–æ—Ç—Ä–∞—á–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é: {total:,.0f} ‚ÇΩ
üìù –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞—Ç: {len(expenses)}
üíµ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {total/len(expenses):,.0f} ‚ÇΩ

üìä –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π:"""
            
            for cat, amount in sorted_cats[:5]:
                percent = (amount / total) * 100
                text += f"\n{cat}: {amount:,.0f} ‚ÇΩ ({percent:.1f}%)"
            
            # Compare with previous week
            prev_week_start = week_start - timedelta(days=7)
            prev_week_end = week_start - timedelta(days=1)
            
            prev_expenses = await Expense.objects.filter(
                profile=profile,
                date__gte=prev_week_start,
                date__lte=prev_week_end
            ).aall()
            
            if prev_expenses:
                prev_total = sum(e.amount for e in prev_expenses)
                diff = total - prev_total
                diff_percent = (diff / prev_total) * 100 if prev_total > 0 else 0
                
                if diff > 0:
                    text += f"\n\nüìà –ü–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ–π: +{diff:,.0f} ‚ÇΩ (+{diff_percent:.1f}%)"
                else:
                    text += f"\n\nüìâ –ü–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ–π: {diff:,.0f} ‚ÇΩ ({diff_percent:.1f}%)"
            
            # Add buttons
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üìÑ –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç PDF", callback_data="generate_pdf_week")]
            ])
            
            await self.bot.send_message(
                chat_id=user_id,
                text=text,
                reply_markup=keyboard
            )
            
            logger.info(f"Weekly report sent to user {user_id}")
            
        except Exception as e:
            logger.error(f"Error sending weekly report to user {user_id}: {e}")
    
    async def send_monthly_report(self, user_id: int, profile: Profile):
        """Send monthly expense report"""
        try:
            today = date.today()
            month_start = today.replace(day=1)
            
            # Get month summary
            summary = await get_month_summary(user_id, today.month, today.year)
            
            if not summary or summary['total'] == 0:
                return
            
            # Format monthly report
            month_names = {
                1: "—è–Ω–≤–∞—Ä—å", 2: "—Ñ–µ–≤—Ä–∞–ª—å", 3: "–º–∞—Ä—Ç", 4: "–∞–ø—Ä–µ–ª—å",
                5: "–º–∞–π", 6: "–∏—é–Ω—å", 7: "–∏—é–ª—å", 8: "–∞–≤–≥—É—Å—Ç",
                9: "—Å–µ–Ω—Ç—è–±—Ä—å", 10: "–æ–∫—Ç—è–±—Ä—å", 11: "–Ω–æ—è–±—Ä—å", 12: "–¥–µ–∫–∞–±—Ä—å"
            }
            
            text = f"""üìä –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç –∑–∞ {month_names[today.month]} {today.year}

üí∞ –ü–æ—Ç—Ä–∞—á–µ–Ω–æ –∑–∞ –º–µ—Å—è—Ü: {summary['total']:,.0f} ‚ÇΩ
üìù –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞—Ç: {summary['count']}
üíµ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {summary['total']/summary['count']:,.0f} ‚ÇΩ

üìä –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π:"""
            
            for cat in summary['categories'][:5]:
                percent = (cat['amount'] / summary['total']) * 100
                text += f"\n{cat['icon']} {cat['name']}: {cat['amount']:,.0f} ‚ÇΩ ({percent:.1f}%)"
            
            # Budget status
            budgets = await Budget.objects.filter(
                profile=profile,
                is_active=True
            ).aall()
            
            if budgets:
                text += "\n\nüí≥ –°—Ç–∞—Ç—É—Å –±—é–¥–∂–µ—Ç–æ–≤:"
                for budget in budgets:
                    spent = await self._get_budget_spent(budget, month_start, today)
                    percent = (spent / budget.amount) * 100 if budget.amount > 0 else 0
                    
                    if percent >= 100:
                        status = "‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω"
                    elif percent >= 80:
                        status = "‚ö†Ô∏è –ë–ª–∏–∑–æ–∫ –∫ –ª–∏–º–∏—Ç—É"
                    else:
                        status = "‚úÖ –í –ø—Ä–µ–¥–µ–ª–∞—Ö"
                    
                    text += f"\n‚Ä¢ {budget.name}: {spent:,.0f}/{budget.amount:,.0f} ‚ÇΩ ({percent:.0f}%) {status}"
            
            # Generate PDF report
            pdf_path = await generate_monthly_report(user_id, today.month, today.year)
            
            # Add buttons
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞", callback_data="analytics_month")],
                [InlineKeyboardButton(text="üí≥ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞–º–∏", callback_data="manage_budgets")]
            ])
            
            # Send message with PDF
            await self.bot.send_document(
                chat_id=user_id,
                document=open(pdf_path, 'rb'),
                caption=text,
                reply_markup=keyboard
            )
            
            logger.info(f"Monthly report sent to user {user_id}")
            
        except Exception as e:
            logger.error(f"Error sending monthly report to user {user_id}: {e}")
    
    async def send_budget_warning(self, user_id: int, budget: Budget, spent: Decimal, percent: float):
        """Send budget warning notification"""
        try:
            text = f"""‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ –±—é–¥–∂–µ—Ç—É!

üí≥ –ë—é–¥–∂–µ—Ç: {budget.name}
üí∞ –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: {spent:,.0f} ‚ÇΩ –∏–∑ {budget.amount:,.0f} ‚ÇΩ
üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {percent:.0f}%

"""
            
            if percent >= 100:
                text += "‚ùå –ë—é–¥–∂–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω! –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏."
            elif percent >= 90:
                text += "‚ö†Ô∏è –û—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω–µ–µ 10% –±—é–¥–∂–µ—Ç–∞. –ë—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã —Å —Ç—Ä–∞—Ç–∞–º–∏."
            else:
                text += "‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –±–æ–ª–µ–µ 80% –±—é–¥–∂–µ—Ç–∞. –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã."
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üìä –ü–æ–¥—Ä–æ–±–Ω–µ–µ", callback_data=f"budget_details_{budget.id}")],
                [InlineKeyboardButton(text="‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç", callback_data=f"edit_budget_{budget.id}")]
            ])
            
            await self.bot.send_message(
                chat_id=user_id,
                text=text,
                reply_markup=keyboard
            )
            
            logger.info(f"Budget warning sent to user {user_id} for budget {budget.name}")
            
        except Exception as e:
            logger.error(f"Error sending budget warning: {e}")
    
    async def _check_budgets(self, profile: Profile, daily_spent: Decimal) -> List[str]:
        """Check budget limits and return warnings"""
        warnings = []
        
        try:
            budgets = await Budget.objects.filter(
                profile=profile,
                is_active=True
            ).aall()
            
            today = date.today()
            
            for budget in budgets:
                if budget.period == 'daily':
                    spent = daily_spent
                    period_text = "–¥–µ–Ω—å"
                elif budget.period == 'weekly':
                    week_start = today - timedelta(days=today.weekday())
                    spent = await self._get_budget_spent(budget, week_start, today)
                    period_text = "–Ω–µ–¥–µ–ª—é"
                elif budget.period == 'monthly':
                    month_start = today.replace(day=1)
                    spent = await self._get_budget_spent(budget, month_start, today)
                    period_text = "–º–µ—Å—è—Ü"
                else:
                    continue
                
                percent = (spent / budget.amount) * 100 if budget.amount > 0 else 0
                
                if percent >= 100:
                    warnings.append(f"{budget.name}: –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞ {period_text} ({spent:,.0f}/{budget.amount:,.0f} ‚ÇΩ)")
                elif percent >= 80:
                    warnings.append(f"{budget.name}: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ {percent:.0f}% –∑–∞ {period_text}")
                
                # Send separate warning notification for critical budgets
                if percent >= 80 and not budget.notified_80_percent:
                    await self.send_budget_warning(profile.telegram_id, budget, spent, percent)
                    budget.notified_80_percent = True
                    await budget.asave()
                
        except Exception as e:
            logger.error(f"Error checking budgets: {e}")
        
        return warnings
    
    async def _get_budget_spent(self, budget: Budget, start_date: date, end_date: date) -> Decimal:
        """Calculate spent amount for budget period"""
        filters = {
            'profile': budget.profile,
            'date__gte': start_date,
            'date__lte': end_date
        }
        
        if budget.category:
            filters['category'] = budget.category
        
        expenses = await Expense.objects.filter(**filters).aall()
        return sum(e.amount for e in expenses)


async def schedule_notifications(bot: Bot):
    """Schedule automatic notifications"""
    service = NotificationService(bot)
    
    # This would be called by Celery beat or similar scheduler
    # For now, just define the structure
    
    async def send_daily_reports():
        """Send daily reports to all users with this preference"""
        profiles = await Profile.objects.filter(
            settings__notifications__daily_report=True
        ).aall()
        
        for profile in profiles:
            await service.send_daily_report(profile.telegram_id, profile)
    
    async def send_weekly_reports():
        """Send weekly reports on Sundays"""
        if datetime.now().weekday() == 6:  # Sunday
            profiles = await Profile.objects.filter(
                settings__notifications__weekly_report=True
            ).aall()
            
            for profile in profiles:
                await service.send_weekly_report(profile.telegram_id, profile)
    
    async def send_monthly_reports():
        """Send monthly reports on the 1st"""
        if datetime.now().day == 1:
            profiles = await Profile.objects.filter(
                settings__notifications__monthly_report=True
            ).aall()
            
            for profile in profiles:
                await service.send_monthly_report(profile.telegram_id, profile)
    
    return {
        'daily': send_daily_reports,
        'weekly': send_weekly_reports,
        'monthly': send_monthly_reports
    }