# üîç Code Review Issues - Expense Bot

## üìÖ –î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: 2025-09-03
## üìÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-09-03

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (2025-09-03):
1. **N+1 –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:**
   - `bot/services/category.py:766` - –¥–æ–±–∞–≤–ª–µ–Ω prefetch_related('categorykeyword_set')
   - `bot/services/income.py:304` - –¥–æ–±–∞–≤–ª–µ–Ω select_related('category')
   - `bot/services/expense_functions.py:729` - –¥–æ–±–∞–≤–ª–µ–Ω select_related('category')

2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - —É–±—Ä–∞–Ω hardcoded –ø–∞—Ä–æ–ª—å:**
   - `create_superuser.py` - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä–æ–ª—å

3. **–£—Ç–µ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∞:**
   - `bot/routers/cashback.py:581, 808` - –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
   - `bot/routers/recurring.py:135, 421, 442` - –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
   - `bot/middlewares/security_check.py:232, 251` - —É–±—Ä–∞–Ω –ø—Ä—è–º–æ–π –≤—ã–≤–æ–¥ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

4. **Bare except –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è (–≤—Å–µ–≥–æ 19 –º–µ—Å—Ç):**
   - `bot/routers/subscription.py` - 7 –º–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (TelegramBadRequest, ObjectDoesNotExist)
   - `bot/routers/expense.py` - 5 –º–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (TelegramForbiddenError, DatabaseError)
   - `bot/routers/categories.py` - 3 –º–µ—Å—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (TelegramBadRequest)
   - `bot/services/google_ai_service.py` - 2 –º–µ—Å—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (json.JSONDecodeError, ValueError)
   - `bot/utils/expense_parser.py` - 2 –º–µ—Å—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (AttributeError, TypeError)
   - `bot/routers/settings.py` - 2 –º–µ—Å—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (pytz.UnknownTimeZoneError)

5. **–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è AI –ø—Ä–æ–º–ø—Ç–æ–≤:**
   - –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `bot/utils/input_sanitizer.py` —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç prompt injection
   - –í–Ω–µ–¥—Ä–µ–Ω–∞ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤ `bot/services/ai_base_service.py`
   - –ó–∞—â–∏—Ç–∞ –æ—Ç 20+ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ prompt injection –∞—Ç–∞–∫
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã, —É–¥–∞–ª–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ (–¢—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

### 1. N+1 –ó–∞–ø—Ä–æ—Å—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

#### 1.1 bot/services/category.py:765
```python
# –ü–†–û–ë–õ–ï–ú–ê: –¶–∏–∫–ª —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
for category in categories:
    keywords = CategoryKeyword.objects.filter(category=category)
```
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å prefetch_related

#### 1.2 bot/services/income.py:301
```python
# –ü–†–û–ë–õ–ï–ú–ê: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç select_related –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
incomes = Income.objects.filter(profile=profile, income_date=today)
```
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å .select_related('category')

#### 1.3 bot/services/expense_functions.py:716
```python
# –ü–†–û–ë–õ–ï–ú–ê: –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –±–µ–∑ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
expenses = Expense.objects.filter(profile=profile, expense_date=today)
```
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å .select_related('category')

### 2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### 2.1 create_superuser.py:29
```python
# –ü–†–û–ë–õ–ï–ú–ê: –ó–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å
password = 'admin123'
```
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –ø–∞—Ä–æ–ª—å

#### 2.2 AI —Å–µ—Ä–≤–∏—Å—ã - Prompt Injection
**–§–∞–π–ª—ã:**
- bot/services/ai_base_service.py:79
- bot/services/google_ai_service.py
- bot/services/openai_service.py

**–ü—Ä–æ–±–ª–µ–º–∞:** User input –Ω–∞–ø—Ä—è–º—É—é –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä—É–µ—Ç—Å—è –≤ –ø—Ä–æ–º–ø—Ç—ã
**–†–µ—à–µ–Ω–∏–µ:** –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤

#### 2.3 –£—Ç–µ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –æ—à–∏–±–∫–∏
**–§–∞–π–ª—ã:**
- bot/routers/cashback.py:581, 808
- bot/middlewares/security_check.py:232, 251
- bot/routers/recurring.py:135, 421, 442

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä—è–º–æ–π –≤—ã–≤–æ–¥ exception –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```python
await message.answer(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
```
**–†–µ—à–µ–Ω–∏–µ:** –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### 3. Bare Except Statements (34 –º–µ—Å—Ç–∞)

**–ù–∞–∏–±–æ–ª–µ–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ:**
- bot/routers/subscription.py (7 –º–µ—Å—Ç): 133, 143, 189, 256, 479, 568, 643
- bot/routers/expense.py (5 –º–µ—Å—Ç): 488, 539, 824, 879, 890
- bot/routers/categories.py (3 –º–µ—Å—Ç–∞): 61, 412, 769
- bot/utils/expense_parser.py (2 –º–µ—Å—Ç–∞): 388, 593
- bot/services/google_ai_service.py (2 –º–µ—Å—Ç–∞): 112, 277
- bot/routers/settings.py (2 –º–µ—Å—Ç–∞): 58, 113

## ‚ö†Ô∏è –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢

### 4. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

#### 4.1 –û–±—Ä–∞–±–æ—Ç–∫–∞ expense –∏ income
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—á—Ç–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π –∫–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–∞—Ç –∏ –¥–æ—Ö–æ–¥–æ–≤
**–§–∞–π–ª—ã:**
- bot/services/expense_functions.py
- bot/services/income.py
- bot/routers/expense.py

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –∏–ª–∏ –æ–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 5. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –ë–î
**–ü–æ–ª—è —Ç—Ä–µ–±—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã:**
- Profile.telegram_id
- Expense.expense_date
- Expense.profile + expense_date (—Å–æ—Å—Ç–∞–≤–Ω–æ–π)
- Income.income_date
- Income.profile + income_date (—Å–æ—Å—Ç–∞–≤–Ω–æ–π)
- RecurringPayment.day_of_month
- RecurringPayment.is_active

## üìä –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢

### 6. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

#### 6.1 –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ —Ç–µ–∫—Å—Ç–∞
**–§–∞–π–ª:** bot/utils/expense_parser.py:300-400
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –≤ Python –≤–º–µ—Å—Ç–æ –ë–î
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PostgreSQL full-text search

#### 6.2 –ò–∑–±—ã—Ç–æ—á–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ sync_to_async
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–Ω–æ–∂–µ—Å—Ç–≤–æ sync_to_async –≤–º–µ—Å—Ç–æ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ async ORM
**–†–µ—à–µ–Ω–∏–µ:** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ async ORM (Tortoise-ORM –∏–ª–∏ Django 4.1+ async)

### 7. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏ –±–µ–∑ user_id –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
```python
logger.error(f"Error: {e}")  # –ü–ª–æ—Ö–æ
logger.error(f"Error for user {user_id} in operation X: {e}")  # –•–æ—Ä–æ—à–æ
```

## üìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê
- **–í—Å–µ–≥–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:** 3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- **Bare except statements:** 34
- **N+1 –ø—Ä–æ–±–ª–µ–º—ã:** 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö + –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ–Ω–µ–µ –≤–∞–∂–Ω—ã—Ö
- **–ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** 3 —Ç–∏–ø–∞
- **–§–∞–π–ª–æ–≤ —Ç—Ä–µ–±—É—é—â–∏—Ö —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:** ~15

## ‚úÖ –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –≠—Ç–∞–ø 1 (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π - –≤—ã–ø–æ–ª–Ω–µ–Ω–æ 2025-09-03):
1. [‚úÖ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –∑–∞–ø—Ä–æ—Å—ã (3 –º–µ—Å—Ç–∞) - –í–´–ü–û–õ–ù–ï–ù–û
2. [‚úÖ] –£–±—Ä–∞—Ç—å hardcoded –ø–∞—Ä–æ–ª—å - –í–´–ü–û–õ–ù–ï–ù–û  
3. [‚úÖ] –ó–∞–∫—Ä—ã—Ç—å —É—Ç–µ—á–∫—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –æ—à–∏–±–∫–∏ - –í–´–ü–û–õ–ù–ï–ù–û
4. [‚úÖ] –ó–∞–º–µ–Ω–∏—Ç—å bare except –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è - –í–´–ü–û–õ–ù–ï–ù–û
5. [‚úÖ] –î–æ–±–∞–≤–∏—Ç—å —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—é –¥–ª—è AI –ø—Ä–æ–º–ø—Ç–æ–≤ - –í–´–ü–û–õ–ù–ï–ù–û
6. [‚úÖ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤ –ë–î - –í–´–ü–û–õ–ù–ï–ù–û

### –≠—Ç–∞–ø 2 (–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç - —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏):
7. [ ] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞ expense/income
8. [ ] –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
9. [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫

### –≠—Ç–∞–ø 3 (–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç - —Å–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è):
7. [ ] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞
8. [ ] –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
9. [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫

## üìù –ó–ê–ú–ï–¢–ö–ò
- –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Å–ª–µ–¥–æ–≤–∞—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø–∞–º production-ready –∫–æ–¥–∞
- –ù–∏–∫–∞–∫–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏–ª–∏ –∫–æ—Å—Ç—ã–ª–µ–π
- –ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ
- –°–ª–µ–¥–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –ø—Ä–æ–µ–∫—Ç–∞